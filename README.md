# Quectel 模組 TCP/IP 協議教學指南

## 目錄
- [概述](#概述)
- [網路基礎架構](#網路基礎架構)
- [IP 協議詳解](#ip-協議詳解)
- [傳輸層協議](#傳輸層協議)
- [應用層協議](#應用層協議)
- [安全協議](#安全協議)
- [Quectel 模組實作範例](#quectel-模組實作範例)
- [常見問題與故障排除](#常見問題與故障排除)

## 概述

本教學指南專為在 Quectel 模組上實作 TCP/IP 協議而設計，涵蓋從 MAC 層到應用層的完整網路協議棧。Quectel 模組（如 EC20、EG91、BG95 等）提供了強大的蜂窩網路連接能力，支援多種網路協議和應用場景。

### Quectel 模組特色
- **多模支援**: 支援 2G/3G/4G/5G 網路
- **豐富協議**: 內建 TCP/UDP/MQTT/HTTP/HTTPS 等協議
- **低功耗**: 優化的電源管理
- **高可靠性**: 工業級設計標準
- **易於整合**: 標準 AT 指令集

## 網路基礎架構

### OSI 七層模型與 TCP/IP 四層模型

```
應用層 (Application Layer)
    ↓
傳輸層 (Transport Layer)     ← TCP/UDP
    ↓
網路層 (Network Layer)       ← IP (IPv4/IPv6)
    ↓
資料鏈路層 (Data Link Layer) ← MAC/PPP
    ↓
實體層 (Physical Layer)      ← 蜂窩網路
```

### MAC 層 (Media Access Control)
MAC 層負責資料在實體媒介上的傳輸控制：

- **蜂窩網路 MAC**: 管理無線資源分配
- **PPP (Point-to-Point Protocol)**: 建立點對點連接
- **資料封裝**: 將上層資料封裝成幀

## IP 協議詳解

### IPv4 (Internet Protocol Version 4)

#### IPv4 地址結構
```
32位元地址 = 網路部分 + 主機部分
例如: 192.168.1.100
```

#### IPv4 地址分類
| 類別 | 範圍 | 預設子網路遮罩 | 用途 |
|------|------|----------------|------|
| A | 1.0.0.0 - 126.255.255.255 | 255.0.0.0 | 大型網路 |
| B | 128.0.0.0 - 191.255.255.255 | 255.255.0.0 | 中型網路 |
| C | 192.0.0.0 - 223.255.255.255 | 255.255.255.0 | 小型網路 |
| D | 224.0.0.0 - 239.255.255.255 | - | 多播 |
| E | 240.0.0.0 - 255.255.255.255 | - | 保留 |

#### IPv4 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ IHL │ 服務類型 │ 總長度                               │
├─────────────────────────────────────────────────────────────┤
│ 識別碼 │ 標誌 │ 分段偏移                                   │
├─────────────────────────────────────────────────────────────┤
│ TTL │ 協議 │ 標頭校驗和                                   │
├─────────────────────────────────────────────────────────────┤
│ 來源 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 目標 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv6 (Internet Protocol Version 6)

#### IPv6 地址結構
```
128位元地址，以16進位表示，用冒號分隔
例如: 2001:0db8:85a3:0000:0000:8a2e:0370:7334
簡化: 2001:db8:85a3::8a2e:370:7334
```

#### IPv6 地址類型
| 類型 | 前綴 | 用途 |
|------|------|------|
| 全域單播 | 2000::/3 | 全域路由 |
| 唯一本地 | fc00::/7 | 私有網路 |
| 鏈路本地 | fe80::/10 | 本地鏈路 |
| 多播 | ff00::/8 | 多播通訊 |
| 回環 | ::1/128 | 本地回環 |

#### IPv6 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ 流量類別 │ 流標籤                                   │
├─────────────────────────────────────────────────────────────┤
│ 載荷長度 │ 下一個標頭 │ 跳躍限制                           │
├─────────────────────────────────────────────────────────────┤
│ 來源地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 目標地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 擴展標頭 (可選)                                             │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv4 與 IPv6 的轉換

#### 雙棧技術 (Dual Stack)
同時支援 IPv4 和 IPv6 協議：
```
應用層
    ↓
傳輸層 (TCP/UDP)
    ↓
網路層 (IPv4 + IPv6)
    ↓
資料鏈路層
```

#### 隧道技術 (Tunneling)
- **6to4**: IPv6 封包封裝在 IPv4 中
- **Teredo**: 通過 UDP 傳輸 IPv6
- **6in4**: 手動配置的 IPv6-in-IPv4 隧道

#### 轉換技術 (Translation)
- **NAT64**: IPv6 客戶端訪問 IPv4 服務器
- **DNS64**: DNS 查詢轉換
- **SIIT**: 無狀態 IP/ICMP 轉換

### Local IP vs Global IP

#### Local IP (私有 IP)
- **範圍**:
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- **用途**: 內部網路通訊
- **特點**: 不可路由到網際網路

#### Global IP (全域 IP)
- **範圍**: 除私有 IP 外的所有地址
- **用途**: 網際網路通訊
- **特點**: 全域唯一，可路由

#### NAT (Network Address Translation)
```
內部網路: 192.168.1.100 → NAT 路由器 → 網際網路: 203.0.113.1
```

## 傳輸層協議

### TCP (Transmission Control Protocol)

#### TCP 特色
- **可靠傳輸**: 確認機制、重傳機制
- **有序傳輸**: 序列號確保資料順序
- **流量控制**: 滑動視窗機制
- **擁塞控制**: 動態調整傳輸速率
- **全雙工**: 同時雙向通訊

#### TCP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 序列號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 確認號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 資料偏移 │ 保留 │ 標誌 │ 視窗大小                           │
├─────────────────────────────────────────────────────────────┤
│ 校驗和 │ 緊急指標                                           │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### TCP 連接狀態機
```
CLOSED → LISTEN → SYN_SENT → ESTABLISHED → CLOSE_WAIT → CLOSED
    ↓         ↓         ↓
SYN_RCVD → ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED
```

#### TCP 應用場景
- **檔案傳輸**: FTP、SFTP
- **網頁瀏覽**: HTTP、HTTPS
- **電子郵件**: SMTP、POP3、IMAP
- **遠端登入**: SSH、Telnet
- **資料庫**: MySQL、PostgreSQL

### UDP (User Datagram Protocol)

#### UDP 特色
- **無連接**: 無需建立連接
- **不可靠**: 無確認機制
- **無序**: 不保證資料順序
- **輕量級**: 標頭開銷小
- **快速**: 低延遲傳輸

#### UDP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 長度 │ 校驗和                                               │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### UDP 應用場景
- **即時通訊**: VoIP、視訊會議
- **遊戲**: 線上遊戲
- **串流媒體**: 音訊、視訊串流
- **DNS**: 網域名稱解析
- **DHCP**: 動態主機配置

## 應用層協議

### MQTT (Message Queuing Telemetry Transport)

#### MQTT 特色
- **輕量級**: 最小化網路頻寬使用
- **QoS 等級**: 三種服務品質等級
- **發布/訂閱模式**: 鬆散耦合的通訊
- **保留訊息**: 新訂閱者可接收最後訊息
- **遺囑訊息**: 異常斷線時發送通知

#### MQTT 封包類型
| 類型 | 值 | 用途 |
|------|----|------|
| CONNECT | 1 | 客戶端連接 |
| CONNACK | 2 | 連接確認 |
| PUBLISH | 3 | 發布訊息 |
| PUBACK | 4 | 發布確認 |
| SUBSCRIBE | 8 | 訂閱主題 |
| SUBACK | 9 | 訂閱確認 |
| DISCONNECT | 14 | 斷開連接 |

#### MQTT QoS 等級
- **QoS 0**: 最多一次傳遞
- **QoS 1**: 至少一次傳遞
- **QoS 2**: 恰好一次傳遞

#### MQTT 應用場景
- **物聯網**: 感測器資料收集
- **智慧家居**: 設備控制
- **工業監控**: 設備狀態監控
- **車聯網**: 車輛資料傳輸

### WebSocket

#### WebSocket 特色
- **全雙工通訊**: 同時雙向資料傳輸
- **持久連接**: 單一連接支援多次通訊
- **低延遲**: 減少連接建立開銷
- **瀏覽器支援**: 原生 JavaScript API
- **協議升級**: 從 HTTP 升級到 WebSocket

#### WebSocket 握手過程
```
客戶端 → HTTP GET (Upgrade: websocket)
    ↓
服務器 → HTTP 101 Switching Protocols
    ↓
WebSocket 連接建立
```

#### WebSocket 幀格式
```
┌─────────────────────────────────────────────────────────────┐
│ FIN │ RSV1 │ RSV2 │ RSV3 │ 操作碼 │ MASK │ 載荷長度         │
├─────────────────────────────────────────────────────────────┤
│ 擴展載荷長度 (可選)                                         │
├─────────────────────────────────────────────────────────────┤
│ 遮罩金鑰 (如果 MASK=1)                                      │
├─────────────────────────────────────────────────────────────┤
│ 載荷資料                                                   │
└─────────────────────────────────────────────────────────────┘
```

#### WebSocket 應用場景
- **即時聊天**: 即時通訊應用
- **線上遊戲**: 多人遊戲
- **協作工具**: 文件協作
- **金融交易**: 即時報價
- **監控儀表板**: 即時資料顯示

### QUIC (Quick UDP Internet Connections)

#### QUIC 特色
- **基於 UDP**: 避免 TCP 的隊頭阻塞
- **內建加密**: TLS 1.3 整合
- **多路復用**: 單一連接多個資料流
- **連接遷移**: 網路切換時保持連接
- **前向糾錯**: 減少重傳需求

#### QUIC vs TCP
| 特性 | QUIC | TCP |
|------|------|-----|
| 傳輸層 | UDP | TCP |
| 加密 | 內建 | 外掛 |
| 多路復用 | 原生支援 | 需要 HTTP/2 |
| 連接遷移 | 支援 | 不支援 |
| 隊頭阻塞 | 無 | 有 |

#### QUIC 應用場景
- **HTTP/3**: 下一代 HTTP 協議
- **串流媒體**: 低延遲視訊串流
- **遊戲**: 即時多人遊戲
- **移動應用**: 網路切換優化

## 安全協議

### TLS (Transport Layer Security)

#### TLS 版本演進
- **TLS 1.0**: 1999年發布
- **TLS 1.1**: 2006年發布
- **TLS 1.2**: 2008年發布
- **TLS 1.3**: 2018年發布（最新）

#### TLS 1.3 特色
- **零往返時間**: 0-RTT 連接恢復
- **強制加密**: 所有連接都加密
- **前向安全性**: 完美前向保密
- **簡化握手**: 減少握手步驟
- **移除弱加密**: 淘汰不安全的加密套件

#### TLS 握手過程
```
客戶端 → ClientHello (支援的加密套件)
    ↓
服務器 → ServerHello (選擇的加密套件)
    ↓
服務器 → Certificate (數位憑證)
    ↓
服務器 → ServerKeyExchange (金鑰交換)
    ↓
客戶端 → ClientKeyExchange (金鑰交換)
    ↓
雙方 → ChangeCipherSpec (切換到加密模式)
    ↓
雙方 → Finished (握手完成)
```

#### TLS 加密套件
```
TLS_AES_256_GCM_SHA384
├── TLS: 協議名稱
├── AES_256: 對稱加密算法
├── GCM: 操作模式
└── SHA384: 雜湊函數
```

### HTTPS (HTTP Secure)

#### HTTPS 特色
- **端到端加密**: 資料在傳輸過程中加密
- **身份驗證**: 防止中間人攻擊
- **資料完整性**: 防止資料篡改
- **SEO 優勢**: 搜尋引擎偏好 HTTPS
- **瀏覽器信任**: 現代瀏覽器要求 HTTPS

#### HTTPS 工作流程
```
1. DNS 解析 → 獲取服務器 IP
2. TCP 連接 → 建立傳輸層連接
3. TLS 握手 → 建立安全通道
4. HTTP 請求/回應 → 在安全通道中傳輸
```

#### 憑證類型
- **DV (Domain Validation)**: 網域驗證
- **OV (Organization Validation)**: 組織驗證
- **EV (Extended Validation)**: 擴展驗證
- **Wildcard**: 萬用字元憑證
- **SAN (Subject Alternative Name)**: 多網域憑證

## Quectel 模組實作範例

### 基本網路配置

#### AT 指令配置網路
```at
// 檢查模組狀態
AT+CPIN?

// 註冊網路
AT+CREG?

// 配置 APN
AT+CGDCONT=1,"IP","internet"

// 連接網路
AT+CGACT=1,1

// 檢查 IP 地址
AT+CGPADDR=1
```

#### TCP 連接範例
```at
// 建立 TCP 連接
AT+QIOPEN=1,0,"TCP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

#### UDP 連接範例
```at
// 建立 UDP 連接
AT+QIOPEN=1,1,"UDP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

### MQTT 實作範例

#### MQTT 連接
```at
// 配置 MQTT 參數
AT+QMTCFG="version",0,4

// 連接到 MQTT 代理
AT+QMTOPEN=0,"mqtt.example.com",1883

// 登入 MQTT
AT+QMTCONN=0,"client_id"

// 訂閱主題
AT+QMTSUB=0,1,"topic/test",1

// 發布訊息
AT+QMTPUB=0,0,0,0,"topic/test"
Hello MQTT

// 斷開連接
AT+QMTDISC=0
```

### HTTPS 實作範例

#### HTTPS 請求
```at
// 配置 HTTPS 參數
AT+QSSLCFG="sslversion",0,4

// 建立 HTTPS 連接
AT+QHTTPGET="https://api.example.com/data"

// 讀取回應
AT+QHTTPREAD

// 關閉連接
AT+QHTTPTERM
```

### WebSocket 實作範例

#### WebSocket 連接
```at
// 建立 WebSocket 連接
AT+QWSOPEN=0,"ws://echo.websocket.org"

// 發送訊息
AT+QWSEND=0,5
Hello

// 接收訊息
AT+QWSRECV=0,100

// 關閉連接
AT+QWSCLOSE=0
```

## 常見問題與故障排除

### 網路連接問題

#### 無法註冊網路
**症狀**: `+CREG: 0,2` 或 `+CREG: 0,3`
**解決方案**:
1. 檢查 SIM 卡是否正確插入
2. 確認 SIM 卡有足夠餘額
3. 檢查訊號強度: `AT+CSQ`
4. 重新啟動模組: `AT+CFUN=1,1`

#### 無法獲取 IP 地址
**症狀**: `+CGPADDR: 1` 返回空值
**解決方案**:
1. 檢查 APN 配置
2. 確認網路註冊狀態
3. 重新啟動 PDP 上下文: `AT+CGACT=0,1` 然後 `AT+CGACT=1,1`

### 協議層問題

#### TCP 連接失敗
**症狀**: `+QIOPEN: 1,0` 返回錯誤
**解決方案**:
1. 檢查目標 IP 和埠號
2. 確認網路連接狀態
3. 檢查防火牆設定
4. 使用 DNS 解析: `AT+QIDNSGIP="example.com"`

#### MQTT 連接問題
**症狀**: `+QMTOPEN: 0,0` 或 `+QMTCONN: 0,0` 返回錯誤
**解決方案**:
1. 檢查 MQTT 代理地址和埠號
2. 確認客戶端 ID 唯一性
3. 檢查使用者名稱和密碼
4. 確認 TLS 配置（如果使用）

### 效能優化

#### 降低功耗
1. **PSM (Power Saving Mode)**: `AT+CPSMS=1`
2. **eDRX (Extended Discontinuous Reception)**: `AT+CEDRXS=1`
3. **適當的資料傳輸間隔**
4. **使用 UDP 而非 TCP**（適用場景）

#### 提高傳輸效率
1. **適當的封包大小**
2. **使用壓縮**: `AT+QHTTPCFG="compress",1`
3. **連接池管理**
4. **非同步處理**

### 除錯技巧

#### 啟用除錯模式
```at
// 啟用詳細錯誤訊息
AT+CMEE=2

// 啟用 AT 指令回顯
ATE1

// 查看模組狀態
AT+CPAS
```

#### 常用除錯指令
```at
// 檢查模組版本
AT+CGMR

// 檢查 IMEI
AT+CGSN=1

// 檢查 SIM 卡資訊
AT+CCID

// 檢查訊號品質
AT+CSQ

// 檢查網路註冊狀態
AT+CREG?

// 檢查 PDP 上下文狀態
AT+CGATT?
```

## 總結

本教學指南涵蓋了在 Quectel 模組上實作 TCP/IP 協議的完整知識體系，從基礎的網路架構到進階的應用層協議。透過深入理解這些協議的特性和實作方式，您將能夠：

1. **選擇合適的協議**: 根據應用需求選擇 TCP、UDP、MQTT 等
2. **優化網路效能**: 透過適當的配置和調優提升傳輸效率
3. **確保通訊安全**: 使用 TLS/HTTPS 保護資料傳輸
4. **解決常見問題**: 快速診斷和解決網路連接問題

隨著 5G 技術的發展和物聯網應用的普及，Quectel 模組將在更多場景中發揮重要作用。持續學習和實踐將幫助您掌握這些技術，並在實際專案中取得成功。

---

**參考資源**:
- [Quectel 官方文檔](https://www.quectel.com/support)
- [RFC 文檔](https://tools.ietf.org/rfc/)
- [MQTT 協議規範](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html)
- [WebSocket 協議規範](https://tools.ietf.org/html/rfc6455) 