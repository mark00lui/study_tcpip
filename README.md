# Quectel 模組 TCP/IP 協議教學指南

## 目錄
- [概述](#概述)
- [網路基礎架構](#網路基礎架構)
- [IP 協議詳解](#ip-協議詳解)
- [傳輸層協議](#傳輸層協議)
- [應用層協議](#應用層協議)
- [安全協議](#安全協議)
- [Quectel 模組實作範例](#quectel-模組實作範例)
- [常見問題與故障排除](#常見問題與故障排除)

## 概述

本教學指南專為在 Quectel 模組上實作 TCP/IP 協議而設計，涵蓋從 MAC 層到應用層的完整網路協議棧。Quectel 模組（如 EC20、EG91、BG95 等）提供了強大的蜂窩網路連接能力，支援多種網路協議和應用場景。

### Quectel 模組特色
- **多模支援**: 支援 2G/3G/4G/5G 網路
- **豐富協議**: 內建 TCP/UDP/MQTT/HTTP/HTTPS 等協議
- **低功耗**: 優化的電源管理
- **高可靠性**: 工業級設計標準
- **易於整合**: 標準 AT 指令集

## 網路基礎架構

### OSI 七層模型與 TCP/IP 四層模型

```
應用層 (Application Layer)
    ↓
傳輸層 (Transport Layer)     ← TCP/UDP
    ↓
網路層 (Network Layer)       ← IP (IPv4/IPv6)
    ↓
資料鏈路層 (Data Link Layer) ← MAC/PPP
    ↓
實體層 (Physical Layer)      ← 蜂窩網路
```

### MAC 層 (Media Access Control)

MAC 層是資料鏈路層的子層，負責控制資料在實體媒介上的傳輸。在蜂窩網路中，MAC 層扮演著關鍵角色，管理無線資源分配和資料傳輸控制。

#### MAC 層主要功能

1. **媒體訪問控制**: 管理多個設備如何共享無線頻道
2. **資料封裝**: 將上層資料封裝成 MAC 幀
3. **錯誤檢測**: 提供基本的錯誤檢測機制
4. **流量控制**: 控制資料傳輸速率
5. **優先級管理**: 處理不同優先級的資料傳輸

#### 蜂窩網路資料鏈路層架構

```
┌─────────────────────────────────────────────────────────────┐
│ 應用層 (Application Layer)                                 │
├─────────────────────────────────────────────────────────────┤
│ 傳輸層 (Transport Layer) - TCP/UDP                        │
├─────────────────────────────────────────────────────────────┤
│ 網路層 (Network Layer) - IP                               │
├─────────────────────────────────────────────────────────────┤
│ 資料鏈路層 (Data Link Layer)                              │
│ ├── PDCP (Packet Data Convergence Protocol) ← 新增重點    │
│ ├── RLC (Radio Link Control) ← 新增重點                   │
│ └── MAC (Media Access Control) ← 本層重點                 │
├─────────────────────────────────────────────────────────────┤
│ 實體層 (Physical Layer) - 無線電傳輸                      │
└─────────────────────────────────────────────────────────────┘
```

#### MAC 層協議類型

##### 1. LTE MAC (Long Term Evolution)
- **下行 MAC**: 從基地台到設備的資料傳輸
- **上行 MAC**: 從設備到基地台的資料傳輸
- **排程機制**: 動態資源分配
- **HARQ**: 混合自動重傳請求

##### 2. 5G NR MAC (New Radio)
- **靈活排程**: 更靈活的時隙配置
- **多波束**: 支援波束成形
- **低延遲**: 支援 URLLC 應用
- **大規模 MIMO**: 多天線技術

##### 3. 2G/3G MAC
- **GSM MAC**: 時分多址 (TDMA)
- **WCDMA MAC**: 碼分多址 (CDMA)
- **GPRS MAC**: 分組資料傳輸

#### MAC 幀結構

```
┌─────────────────────────────────────────────────────────────┐
│ MAC 標頭 (MAC Header)                                      │
│ ├── 控制欄位 (Control Fields)                              │
│ ├── 地址欄位 (Address Fields)                              │
│ └── 長度欄位 (Length Field)                                │
├─────────────────────────────────────────────────────────────┤
│ MAC 載荷 (MAC Payload)                                     │
│ ├── 邏輯通道 ID (Logical Channel ID)                       │
│ ├── 序列號 (Sequence Number)                               │
│ └── 資料 (Data)                                            │
├─────────────────────────────────────────────────────────────┤
│ MAC 尾部 (MAC Trailer)                                     │
│ └── 校驗和 (Checksum)                                      │
└─────────────────────────────────────────────────────────────┘
```

#### MAC 層關鍵機制

##### 1. 資源排程 (Resource Scheduling)
```
基地台排程器
    ↓
分配無線資源
    ↓
MAC 層處理
    ↓
實體層傳輸
```

##### 2. 邏輯通道 (Logical Channels)
- **控制通道**: 傳輸控制資訊
- **業務通道**: 傳輸用戶資料
- **廣播通道**: 系統廣播資訊

##### 3. 傳輸格式組合 (Transport Format Combination)
- 定義資料傳輸的格式和參數
- 包括調製方式、編碼率、傳輸塊大小等

#### PPP (Point-to-Point Protocol)

PPP 是在點對點連接上傳輸多協議資料包的標準方法，在蜂窩網路中廣泛使用。

##### PPP 層結構
```
┌─────────────────────────────────────────────────────────────┐
│ IP 封包 (IP Packet)                                        │
├─────────────────────────────────────────────────────────────┤
│ PPP 載荷 (PPP Payload)                                     │
├─────────────────────────────────────────────────────────────┤
│ PPP 標頭 (PPP Header)                                      │
│ ├── 標誌 (Flag) - 0x7E                                     │
│ ├── 地址 (Address) - 0xFF                                  │
│ ├── 控制 (Control) - 0x03                                  │
│ └── 協議 (Protocol) - 0x0021 (IPv4)                       │
└─────────────────────────────────────────────────────────────┘
```

##### PPP 協議類型
| 協議 | 值 | 用途 |
|------|----|------|
| IPv4 | 0x0021 | Internet Protocol v4 |
| IPv6 | 0x0057 | Internet Protocol v6 |
| LCP | 0xC021 | Link Control Protocol |
| NCP | 0x8021 | Network Control Protocol |
| CHAP | 0xC223 | Challenge Handshake Authentication Protocol |
| PAP | 0xC023 | Password Authentication Protocol |

##### PPP 連接階段
```
1. 鏈路建立 (Link Establishment)
   ↓
2. 認證 (Authentication) - 可選
   ↓
3. 網路層配置 (Network Layer Configuration)
   ↓
4. 資料傳輸 (Data Transfer)
   ↓
5. 鏈路終止 (Link Termination)
```

### PDCP (Packet Data Convergence Protocol)

PDCP 層位於 RLC 層之上，負責處理 IP 封包的壓縮、加密和完整性保護。

#### PDCP 層主要功能

1. **IP 標頭壓縮**: 減少 IP 標頭開銷
2. **資料加密**: 提供資料機密性保護
3. **完整性保護**: 防止資料篡改
4. **重排序**: 處理重傳封包的順序
5. **重複檢測**: 避免重複封包處理

#### PDCP 層架構

```
┌─────────────────────────────────────────────────────────────┐
│ PDCP 層 (Packet Data Convergence Protocol)                │
│ ├── 控制平面 (Control Plane)                               │
│ │   ├── RRC 訊息處理                                       │
│ │   └── 控制訊息加密                                       │
│ └── 用戶平面 (User Plane)                                  │
│     ├── IP 封包處理                                        │
│     ├── 標頭壓縮                                           │
│     └── 資料加密                                           │
└─────────────────────────────────────────────────────────────┘
```

#### PDCP 封包結構

```
┌─────────────────────────────────────────────────────────────┐
│ PDCP 標頭 (PDCP Header)                                    │
│ ├── D/C 位元 (Data/Control)                               │
│ ├── 序列號 (Sequence Number) - 12位元                      │
│ └── 保留位元 (Reserved Bits)                              │
├─────────────────────────────────────────────────────────────┤
│ PDCP 載荷 (PDCP Payload)                                   │
│ ├── 壓縮標頭 (Compressed Header) - 可選                    │
│ ├── 加密資料 (Encrypted Data)                              │
│ └── 完整性保護 (Integrity Protection) - 可選               │
└─────────────────────────────────────────────────────────────┘
```

#### PDCP 標頭壓縮

##### ROHC (Robust Header Compression)
- **IP/UDP/RTP 壓縮**: 減少即時通訊開銷
- **IP/TCP 壓縮**: 減少一般資料傳輸開銷
- **IP 壓縮**: 僅壓縮 IP 標頭

##### 壓縮模式
| 模式 | 描述 | 適用場景 |
|------|------|----------|
| 非壓縮 | 不進行壓縮 | 測試環境 |
| 靜態壓縮 | 壓縮靜態欄位 | 一般應用 |
| 動態壓縮 | 壓縮動態欄位 | 即時通訊 |

#### PDCP 加密與完整性保護

##### 加密算法
- **AES**: 進階加密標準
- **SNOW 3G**: 3GPP 標準加密算法
- **ZUC**: 中國標準加密算法

##### 完整性保護
- **HMAC-SHA-256**: 基於 SHA-256 的完整性保護
- **AES-CMAC**: 基於 AES 的完整性保護

### RLC (Radio Link Control)

RLC 層位於 PDCP 層和 MAC 層之間，負責資料分段、重組和錯誤恢復。

#### RLC 層主要功能

1. **分段與重組**: 將大封包分段傳輸
2. **錯誤檢測**: 檢測傳輸錯誤
3. **重傳機制**: 自動重傳錯誤封包
4. **流量控制**: 控制資料傳輸速率
5. **序列號管理**: 確保封包順序

#### RLC 層模式

##### 1. TM (Transparent Mode) - 透明模式
- **特點**: 不進行分段或重組
- **適用**: 廣播/多播資料
- **開銷**: 最小
- **可靠性**: 無錯誤恢復

##### 2. UM (Unacknowledged Mode) - 非確認模式
- **特點**: 分段但不重傳
- **適用**: 即時應用 (VoIP, 視訊)
- **開銷**: 中等
- **可靠性**: 有限錯誤恢復

##### 3. AM (Acknowledged Mode) - 確認模式
- **特點**: 分段且重傳
- **適用**: 可靠資料傳輸
- **開銷**: 最大
- **可靠性**: 完整錯誤恢復

#### RLC 封包結構

```
┌─────────────────────────────────────────────────────────────┐
│ RLC 標頭 (RLC Header)                                      │
│ ├── 模式識別 (Mode Identifier)                             │
│ ├── 序列號 (Sequence Number)                               │
│ ├── 分段資訊 (Segmentation Info)                           │
│ └── 長度指示器 (Length Indicator)                          │
├─────────────────────────────────────────────────────────────┤
│ RLC 載荷 (RLC Payload)                                     │
│ ├── 資料段 (Data Segment)                                  │
│ └── 填充 (Padding) - 可選                                  │
└─────────────────────────────────────────────────────────────┘
```

#### RLC 層關鍵機制

##### 1. 分段與重組
```
原始封包 (1500 bytes)
    ↓
分段 1 (500 bytes) + 分段 2 (500 bytes) + 分段 3 (500 bytes)
    ↓
傳輸
    ↓
重組 → 原始封包 (1500 bytes)
```

##### 2. 滑動視窗機制
```
發送視窗: [1, 2, 3, 4, 5, 6, 7, 8]
接收視窗: [1, 2, 3, 4, 5, 6, 7, 8]
    ↓
收到 ACK 3
    ↓
發送視窗: [4, 5, 6, 7, 8, 9, 10, 11]
```

##### 3. 重傳機制
```
發送封包 1, 2, 3, 4, 5
    ↓
接收方回應: ACK 1, NACK 2, ACK 3, ACK 4, ACK 5
    ↓
重傳封包 2
    ↓
接收方回應: ACK 2
```

#### RLC 層效能參數

##### 視窗大小配置
- **發送視窗大小**: 控制發送緩衝區
- **接收視窗大小**: 控制接收緩衝區
- **重傳計時器**: 控制重傳延遲

##### 分段大小配置
- **最大分段大小**: 影響傳輸效率
- **最小分段大小**: 影響開銷
- **動態分段**: 根據網路狀況調整

## IP 協議詳解

### IPv4 (Internet Protocol Version 4)

#### IPv4 地址結構
```
32位元地址 = 網路部分 + 主機部分
例如: 192.168.1.100
```

#### IPv4 地址分類
| 類別 | 範圍 | 預設子網路遮罩 | 用途 |
|------|------|----------------|------|
| A | 1.0.0.0 - 126.255.255.255 | 255.0.0.0 | 大型網路 |
| B | 128.0.0.0 - 191.255.255.255 | 255.255.0.0 | 中型網路 |
| C | 192.0.0.0 - 223.255.255.255 | 255.255.255.0 | 小型網路 |
| D | 224.0.0.0 - 239.255.255.255 | - | 多播 |
| E | 240.0.0.0 - 255.255.255.255 | - | 保留 |

#### IPv4 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ IHL │ 服務類型 │ 總長度                               │
├─────────────────────────────────────────────────────────────┤
│ 識別碼 │ 標誌 │ 分段偏移                                   │
├─────────────────────────────────────────────────────────────┤
│ TTL │ 協議 │ 標頭校驗和                                   │
├─────────────────────────────────────────────────────────────┤
│ 來源 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 目標 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv6 (Internet Protocol Version 6)

#### IPv6 地址結構
```
128位元地址，以16進位表示，用冒號分隔
例如: 2001:0db8:85a3:0000:0000:8a2e:0370:7334
簡化: 2001:db8:85a3::8a2e:370:7334
```

#### IPv6 地址類型
| 類型 | 前綴 | 用途 |
|------|------|------|
| 全域單播 | 2000::/3 | 全域路由 |
| 唯一本地 | fc00::/7 | 私有網路 |
| 鏈路本地 | fe80::/10 | 本地鏈路 |
| 多播 | ff00::/8 | 多播通訊 |
| 回環 | ::1/128 | 本地回環 |

#### IPv6 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ 流量類別 │ 流標籤                                   │
├─────────────────────────────────────────────────────────────┤
│ 載荷長度 │ 下一個標頭 │ 跳躍限制                           │
├─────────────────────────────────────────────────────────────┤
│ 來源地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 目標地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 擴展標頭 (可選)                                             │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv4 與 IPv6 的轉換

#### 雙棧技術 (Dual Stack)
同時支援 IPv4 和 IPv6 協議：
```
應用層
    ↓
傳輸層 (TCP/UDP)
    ↓
網路層 (IPv4 + IPv6)
    ↓
資料鏈路層
```

#### 隧道技術 (Tunneling)
- **6to4**: IPv6 封包封裝在 IPv4 中
- **Teredo**: 通過 UDP 傳輸 IPv6
- **6in4**: 手動配置的 IPv6-in-IPv4 隧道

#### 轉換技術 (Translation)
- **NAT64**: IPv6 客戶端訪問 IPv4 服務器
- **DNS64**: DNS 查詢轉換
- **SIIT**: 無狀態 IP/ICMP 轉換

### Local IP vs Global IP

#### Local IP (私有 IP)
- **範圍**:
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- **用途**: 內部網路通訊
- **特點**: 不可路由到網際網路

#### Global IP (全域 IP)
- **範圍**: 除私有 IP 外的所有地址
- **用途**: 網際網路通訊
- **特點**: 全域唯一，可路由

#### NAT (Network Address Translation)
```
內部網路: 192.168.1.100 → NAT 路由器 → 網際網路: 203.0.113.1
```

## 傳輸層協議

### TCP (Transmission Control Protocol)

#### TCP 特色
- **可靠傳輸**: 確認機制、重傳機制
- **有序傳輸**: 序列號確保資料順序
- **流量控制**: 滑動視窗機制
- **擁塞控制**: 動態調整傳輸速率
- **全雙工**: 同時雙向通訊

#### TCP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 序列號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 確認號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 資料偏移 │ 保留 │ 標誌 │ 視窗大小                           │
├─────────────────────────────────────────────────────────────┤
│ 校驗和 │ 緊急指標                                           │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### TCP 連接狀態機
```
CLOSED → LISTEN → SYN_SENT → ESTABLISHED → CLOSE_WAIT → CLOSED
    ↓         ↓         ↓
SYN_RCVD → ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED
```

#### TCP 應用場景
- **檔案傳輸**: FTP、SFTP
- **網頁瀏覽**: HTTP、HTTPS
- **電子郵件**: SMTP、POP3、IMAP
- **遠端登入**: SSH、Telnet
- **資料庫**: MySQL、PostgreSQL

### UDP (User Datagram Protocol)

#### UDP 特色
- **無連接**: 無需建立連接
- **不可靠**: 無確認機制
- **無序**: 不保證資料順序
- **輕量級**: 標頭開銷小
- **快速**: 低延遲傳輸

#### UDP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 長度 │ 校驗和                                               │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### UDP 應用場景
- **即時通訊**: VoIP、視訊會議
- **遊戲**: 線上遊戲
- **串流媒體**: 音訊、視訊串流
- **DNS**: 網域名稱解析
- **DHCP**: 動態主機配置

## 應用層協議

### MQTT (Message Queuing Telemetry Transport)

#### MQTT 特色
- **輕量級**: 最小化網路頻寬使用
- **QoS 等級**: 三種服務品質等級
- **發布/訂閱模式**: 鬆散耦合的通訊
- **保留訊息**: 新訂閱者可接收最後訊息
- **遺囑訊息**: 異常斷線時發送通知

#### MQTT 封包類型
| 類型 | 值 | 用途 |
|------|----|------|
| CONNECT | 1 | 客戶端連接 |
| CONNACK | 2 | 連接確認 |
| PUBLISH | 3 | 發布訊息 |
| PUBACK | 4 | 發布確認 |
| SUBSCRIBE | 8 | 訂閱主題 |
| SUBACK | 9 | 訂閱確認 |
| DISCONNECT | 14 | 斷開連接 |

#### MQTT QoS 等級
- **QoS 0**: 最多一次傳遞
- **QoS 1**: 至少一次傳遞
- **QoS 2**: 恰好一次傳遞

#### MQTT 應用場景
- **物聯網**: 感測器資料收集
- **智慧家居**: 設備控制
- **工業監控**: 設備狀態監控
- **車聯網**: 車輛資料傳輸

### WebSocket

#### WebSocket 特色
- **全雙工通訊**: 同時雙向資料傳輸
- **持久連接**: 單一連接支援多次通訊
- **低延遲**: 減少連接建立開銷
- **瀏覽器支援**: 原生 JavaScript API
- **協議升級**: 從 HTTP 升級到 WebSocket

#### WebSocket 握手過程
```
客戶端 → HTTP GET (Upgrade: websocket)
    ↓
服務器 → HTTP 101 Switching Protocols
    ↓
WebSocket 連接建立
```

#### WebSocket 幀格式
```
┌─────────────────────────────────────────────────────────────┐
│ FIN │ RSV1 │ RSV2 │ RSV3 │ 操作碼 │ MASK │ 載荷長度         │
├─────────────────────────────────────────────────────────────┤
│ 擴展載荷長度 (可選)                                         │
├─────────────────────────────────────────────────────────────┤
│ 遮罩金鑰 (如果 MASK=1)                                      │
├─────────────────────────────────────────────────────────────┤
│ 載荷資料                                                   │
└─────────────────────────────────────────────────────────────┘
```

#### WebSocket 應用場景
- **即時聊天**: 即時通訊應用
- **線上遊戲**: 多人遊戲
- **協作工具**: 文件協作
- **金融交易**: 即時報價
- **監控儀表板**: 即時資料顯示

### QUIC (Quick UDP Internet Connections)

#### QUIC 特色
- **基於 UDP**: 避免 TCP 的隊頭阻塞
- **內建加密**: TLS 1.3 整合
- **多路復用**: 單一連接多個資料流
- **連接遷移**: 網路切換時保持連接
- **前向糾錯**: 減少重傳需求

#### QUIC vs TCP
| 特性 | QUIC | TCP |
|------|------|-----|
| 傳輸層 | UDP | TCP |
| 加密 | 內建 | 外掛 |
| 多路復用 | 原生支援 | 需要 HTTP/2 |
| 連接遷移 | 支援 | 不支援 |
| 隊頭阻塞 | 無 | 有 |

#### QUIC 應用場景
- **HTTP/3**: 下一代 HTTP 協議
- **串流媒體**: 低延遲視訊串流
- **遊戲**: 即時多人遊戲
- **移動應用**: 網路切換優化

## 安全協議

### TLS (Transport Layer Security)

#### TLS 版本演進
- **TLS 1.0**: 1999年發布
- **TLS 1.1**: 2006年發布
- **TLS 1.2**: 2008年發布
- **TLS 1.3**: 2018年發布（最新）

#### TLS 1.3 特色
- **零往返時間**: 0-RTT 連接恢復
- **強制加密**: 所有連接都加密
- **前向安全性**: 完美前向保密
- **簡化握手**: 減少握手步驟
- **移除弱加密**: 淘汰不安全的加密套件

#### TLS 握手過程
```
客戶端 → ClientHello (支援的加密套件)
    ↓
服務器 → ServerHello (選擇的加密套件)
    ↓
服務器 → Certificate (數位憑證)
    ↓
服務器 → ServerKeyExchange (金鑰交換)
    ↓
客戶端 → ClientKeyExchange (金鑰交換)
    ↓
雙方 → ChangeCipherSpec (切換到加密模式)
    ↓
雙方 → Finished (握手完成)
```

#### TLS 加密套件
```
TLS_AES_256_GCM_SHA384
├── TLS: 協議名稱
├── AES_256: 對稱加密算法
├── GCM: 操作模式
└── SHA384: 雜湊函數
```

### HTTPS (HTTP Secure)

#### HTTPS 特色
- **端到端加密**: 資料在傳輸過程中加密
- **身份驗證**: 防止中間人攻擊
- **資料完整性**: 防止資料篡改
- **SEO 優勢**: 搜尋引擎偏好 HTTPS
- **瀏覽器信任**: 現代瀏覽器要求 HTTPS

#### HTTPS 工作流程
```
1. DNS 解析 → 獲取服務器 IP
2. TCP 連接 → 建立傳輸層連接
3. TLS 握手 → 建立安全通道
4. HTTP 請求/回應 → 在安全通道中傳輸
```

#### 憑證類型
- **DV (Domain Validation)**: 網域驗證
- **OV (Organization Validation)**: 組織驗證
- **EV (Extended Validation)**: 擴展驗證
- **Wildcard**: 萬用字元憑證
- **SAN (Subject Alternative Name)**: 多網域憑證

## Quectel 模組實作範例

### MAC 層配置與支援

#### Quectel 模組 MAC 層支援

Quectel 模組在 MAC 層提供了完整的蜂窩網路協議支援，包括：

##### 1. 多模網路支援
```at
// 檢查模組支援的網路模式
AT+QCFG="nwscanmode"

// 設定網路掃描模式
AT+QCFG="nwscanmode",3,1,3,1

// 檢查當前網路模式
AT+QNWINFO
```

##### 2. 網路註冊與 MAC 層連接
```at
// 檢查網路註冊狀態
AT+CREG?

// 檢查 GPRS 服務狀態
AT+CGATT?

// 檢查網路運營商
AT+COPS?

// 檢查訊號品質 (影響 MAC 層傳輸)
AT+CSQ
```

##### 3. MAC 層參數配置

###### 傳輸功率控制
```at
// 檢查發射功率等級
AT+QPOWD?

// 設定發射功率等級 (0-5)
AT+QPOWD=3
```

###### 接收靈敏度配置
```at
// 檢查接收靈敏度
AT+QRSRP?

// 設定接收靈敏度閾值
AT+QRSRP=1,-120,-110
```

###### 頻道配置
```at
// 檢查頻道配置
AT+QCFG="band"

// 設定頻段 (例如: LTE Band 1,3,5,8)
AT+QCFG="band",0x80,0x800800,0x800800,0x0
```

##### 4. PPP 連接配置

###### PPP 基本配置
```at
// 配置 PPP 連接參數
AT+CGDCONT=1,"IP","internet"

// 啟動 PPP 連接
AT+CGACT=1,1

// 檢查 PPP 連接狀態
AT+CGACT?
```

###### PPP 認證配置
```at
// 配置 PAP 認證
AT+CGDCONT=1,"IP","internet","",0,0,"PAP"

// 配置 CHAP 認證
AT+CGDCONT=1,"IP","internet","",0,0,"CHAP"

// 設定認證資訊
AT+CGAUTH=1,1,"username","password"
```

##### 5. MAC 層效能監控

###### 傳輸統計
```at
// 檢查資料傳輸統計
AT+QISTATS

// 檢查網路連接統計
AT+QNWINFO
```

###### 錯誤率監控
```at
// 檢查 HARQ 重傳統計
AT+QHARQ?

// 檢查 CRC 錯誤統計
AT+QCRC?
```

##### 6. 進階 MAC 層功能

###### 載波聚合 (Carrier Aggregation)
```at
// 檢查載波聚合支援
AT+QCAINFO?

// 配置載波聚合
AT+QCFG="ca",1
```

###### MIMO 配置
```at
// 檢查 MIMO 配置
AT+QMIMO?

// 設定 MIMO 模式
AT+QMIMO=1,2  // 2x2 MIMO
```

###### 波束成形 (5G)
```at
// 檢查波束成形狀態
AT+QBEAM?

// 配置波束成形
AT+QBEAM=1
```

##### 7. MAC 層除錯指令

###### 詳細狀態檢查
```at
// 檢查詳細網路狀態
AT+QNWINFO

// 檢查無線資源狀態
AT+QNWINFO=1

// 檢查 MAC 層統計
AT+QMACINFO
```

###### 連接品質監控
```at
// 檢查 RSRP (參考信號接收功率)
AT+QRSRP

// 檢查 RSRQ (參考信號接收品質)
AT+QRSRQ

// 檢查 SINR (信號干擾噪聲比)
AT+QSINR
```

##### 8. MAC 層優化配置

###### 低延遲配置
```at
// 配置低延遲模式
AT+QCFG="latency",1

// 設定 QoS 等級
AT+QCFG="qos",1,1
```

###### 省電模式配置
```at
// 配置 PSM (Power Saving Mode)
AT+CPSMS=1,"00000001","00000001"

// 配置 eDRX (Extended Discontinuous Reception)
AT+CEDRXS=1,5,"0001"
```

###### 傳輸優化
```at
// 配置 TCP 優化
AT+QCFG="tcp",1,1

// 配置 UDP 優化
AT+QCFG="udp",1,1
```

##### 9. PDCP 層配置

###### PDCP 標頭壓縮配置
```at
// 檢查 PDCP 壓縮狀態
AT+QPDCP?

// 啟用 ROHC 壓縮
AT+QPDCP=1

// 配置壓縮模式 (0=非壓縮, 1=靜態壓縮, 2=動態壓縮)
AT+QPDCP=1,2

// 配置壓縮協議 (1=IP, 2=IP/UDP, 3=IP/UDP/RTP)
AT+QPDCP=1,2,3
```

###### PDCP 加密配置
```at
// 檢查加密狀態
AT+QENCRYPT?

// 啟用 PDCP 加密
AT+QENCRYPT=1

// 配置加密算法 (1=AES, 2=SNOW3G, 3=ZUC)
AT+QENCRYPT=1,1

// 配置完整性保護
AT+QENCRYPT=1,1,1
```

###### PDCP 序列號配置
```at
// 檢查序列號配置
AT+QPDCPSN?

// 設定序列號大小 (12位元或18位元)
AT+QPDCPSN=12

// 配置重排序計時器
AT+QPDCPSN=12,1000
```

##### 10. RLC 層配置

###### RLC 模式配置
```at
// 檢查 RLC 模式
AT+QRLC?

// 設定 RLC 模式 (1=TM, 2=UM, 3=AM)
AT+QRLC=3

// 配置 UM 模式參數
AT+QRLC=2,1024,1000

// 配置 AM 模式參數
AT+QRLC=3,2048,2000,500
```

###### RLC 視窗大小配置
```at
// 檢查視窗大小
AT+QRLCWIN?

// 設定發送視窗大小
AT+QRLCWIN=2048

// 設定接收視窗大小
AT+QRLCWIN=2048,2048

// 配置重傳計時器
AT+QRLCWIN=2048,2048,500
```

###### RLC 分段配置
```at
// 檢查分段配置
AT+QRLCSEG?

// 設定最大分段大小
AT+QRLCSEG=1500

// 設定最小分段大小
AT+QRLCSEG=1500,100

// 啟用動態分段
AT+QRLCSEG=1500,100,1
```

##### 11. PDCP/RLC 效能監控

###### PDCP 統計
```at
// 檢查 PDCP 統計資訊
AT+QPDCPSTAT?

// 檢查壓縮統計
AT+QPDCPSTAT=1

// 檢查加密統計
AT+QPDCPSTAT=2
```

###### RLC 統計
```at
// 檢查 RLC 統計資訊
AT+QRLCSTAT?

// 檢查重傳統計
AT+QRLCSTAT=1

// 檢查分段統計
AT+QRLCSTAT=2
```

##### 12. PDCP/RLC 除錯指令

###### PDCP 除錯
```at
// 啟用 PDCP 除錯模式
AT+QPDCPDEBUG=1

// 檢查 PDCP 狀態
AT+QPDCPSTATUS

// 檢查壓縮效率
AT+QPDCPEFF
```

###### RLC 除錯
```at
// 啟用 RLC 除錯模式
AT+QRLCDEBUG=1

// 檢查 RLC 狀態
AT+QRLCSTATUS

// 檢查視窗狀態
AT+QRLCWINDOW
```

### 基本網路配置

#### AT 指令配置網路
```at
// 檢查模組狀態
AT+CPIN?

// 註冊網路
AT+CREG?

// 配置 APN
AT+CGDCONT=1,"IP","internet"

// 連接網路
AT+CGACT=1,1

// 檢查 IP 地址
AT+CGPADDR=1
```

#### TCP 連接範例
```at
// 建立 TCP 連接
AT+QIOPEN=1,0,"TCP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

#### UDP 連接範例
```at
// 建立 UDP 連接
AT+QIOPEN=1,1,"UDP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

### MQTT 實作範例

#### MQTT 連接
```at
// 配置 MQTT 參數
AT+QMTCFG="version",0,4

// 連接到 MQTT 代理
AT+QMTOPEN=0,"mqtt.example.com",1883

// 登入 MQTT
AT+QMTCONN=0,"client_id"

// 訂閱主題
AT+QMTSUB=0,1,"topic/test",1

// 發布訊息
AT+QMTPUB=0,0,0,0,"topic/test"
Hello MQTT

// 斷開連接
AT+QMTDISC=0
```

### HTTPS 實作範例

#### HTTPS 請求
```at
// 配置 HTTPS 參數
AT+QSSLCFG="sslversion",0,4

// 建立 HTTPS 連接
AT+QHTTPGET="https://api.example.com/data"

// 讀取回應
AT+QHTTPREAD

// 關閉連接
AT+QHTTPTERM
```

### WebSocket 實作範例

#### WebSocket 連接
```at
// 建立 WebSocket 連接
AT+QWSOPEN=0,"ws://echo.websocket.org"

// 發送訊息
AT+QWSEND=0,5
Hello

// 接收訊息
AT+QWSRECV=0,100

// 關閉連接
AT+QWSCLOSE=0
```

## 常見問題與故障排除

### MAC 層與網路連接問題

#### MAC 層連接問題

##### 無法註冊網路
**症狀**: `+CREG: 0,2` 或 `+CREG: 0,3`
**MAC 層原因**:
- MAC 層資源分配失敗
- 無線頻道擁塞
- 基地台拒絕連接
**解決方案**:
1. 檢查 SIM 卡是否正確插入
2. 確認 SIM 卡有足夠餘額
3. 檢查訊號強度: `AT+CSQ`
4. 重新啟動模組: `AT+CFUN=1,1`
5. 檢查 MAC 層狀態: `AT+QMACINFO`
6. 重新配置頻段: `AT+QCFG="band"`

##### MAC 層傳輸錯誤
**症狀**: 資料傳輸不穩定或錯誤率高
**MAC 層原因**:
- HARQ 重傳次數過多
- MAC 層緩衝區溢出
- 無線資源不足
**解決方案**:
1. 檢查 HARQ 統計: `AT+QHARQ?`
2. 檢查 CRC 錯誤: `AT+QCRC?`
3. 調整傳輸功率: `AT+QPOWD`
4. 檢查 MAC 層統計: `AT+QISTATS`
5. 重新配置 QoS 參數

##### PPP 連接失敗
**症狀**: `+CGACT: 1,0` 返回錯誤
**MAC 層原因**:
- PPP 認證失敗
- MAC 層資源不足
- 網路擁塞
**解決方案**:
1. 檢查 PPP 配置: `AT+CGDCONT?`
2. 重新配置認證: `AT+CGAUTH`
3. 檢查 MAC 層狀態: `AT+QMACINFO`
4. 重新啟動 PDP 上下文

##### PDCP 層問題

###### PDCP 壓縮失敗
**症狀**: 資料傳輸效率低，頻寬使用率高
**PDCP 層原因**:
- 標頭壓縮配置錯誤
- 壓縮算法不匹配
- 序列號溢出
**解決方案**:
1. 檢查 PDCP 壓縮狀態: `AT+QPDCP?`
2. 重新配置壓縮模式: `AT+QPDCP=1,2`
3. 檢查序列號配置: `AT+QPDCPSN?`
4. 重置 PDCP 層: `AT+QPDCPRESET`

###### PDCP 加密錯誤
**症狀**: 資料傳輸失敗或安全警告
**PDCP 層原因**:
- 加密算法不匹配
- 金鑰配置錯誤
- 完整性保護失敗
**解決方案**:
1. 檢查加密配置: `AT+QENCRYPT?`
2. 重新配置加密算法: `AT+QENCRYPT=1,1`
3. 檢查金鑰配置
4. 重新建立安全上下文

##### RLC 層問題

###### RLC 重傳過多
**症狀**: 傳輸延遲高，吞吐量低
**RLC 層原因**:
- 視窗大小配置不當
- 重傳計時器過短
- 網路品質差
**解決方案**:
1. 檢查 RLC 統計: `AT+QRLCSTAT?`
2. 調整視窗大小: `AT+QRLCWIN=4096`
3. 增加重傳計時器: `AT+QRLCWIN=4096,4096,1000`
4. 檢查網路品質: `AT+CSQ`

###### RLC 分段錯誤
**症狀**: 資料丟失或重複
**RLC 層原因**:
- 分段大小配置錯誤
- 序列號管理問題
- 緩衝區溢出
**解決方案**:
1. 檢查分段配置: `AT+QRLCSEG?`
2. 調整分段大小: `AT+QRLCSEG=1500`
3. 檢查 RLC 狀態: `AT+QRLCSTATUS`
4. 重新配置 RLC 模式: `AT+QRLC=3`

#### 網路連接問題
**症狀**: `+CREG: 0,2` 或 `+CREG: 0,3`
**解決方案**:
1. 檢查 SIM 卡是否正確插入
2. 確認 SIM 卡有足夠餘額
3. 檢查訊號強度: `AT+CSQ`
4. 重新啟動模組: `AT+CFUN=1,1`

#### 無法獲取 IP 地址
**症狀**: `+CGPADDR: 1` 返回空值
**解決方案**:
1. 檢查 APN 配置
2. 確認網路註冊狀態
3. 重新啟動 PDP 上下文: `AT+CGACT=0,1` 然後 `AT+CGACT=1,1`

### 協議層問題

#### TCP 連接失敗
**症狀**: `+QIOPEN: 1,0` 返回錯誤
**解決方案**:
1. 檢查目標 IP 和埠號
2. 確認網路連接狀態
3. 檢查防火牆設定
4. 使用 DNS 解析: `AT+QIDNSGIP="example.com"`

#### MQTT 連接問題
**症狀**: `+QMTOPEN: 0,0` 或 `+QMTCONN: 0,0` 返回錯誤
**解決方案**:
1. 檢查 MQTT 代理地址和埠號
2. 確認客戶端 ID 唯一性
3. 檢查使用者名稱和密碼
4. 確認 TLS 配置（如果使用）

### 效能優化

#### MAC 層效能優化

##### 傳輸功率優化
```at
// 根據訊號強度調整傳輸功率
AT+QPOWD=3  // 中等功率，平衡效能與功耗

// 動態功率控制
AT+QCFG="power",1  // 啟用動態功率控制
```

##### 頻道選擇優化
```at
// 選擇最佳頻段組合
AT+QCFG="band",0x80,0x800800,0x800800,0x0

// 配置載波聚合
AT+QCFG="ca",1  // 啟用載波聚合提升頻寬
```

##### MIMO 配置優化
```at
// 配置 2x2 MIMO 提升傳輸效率
AT+QMIMO=1,2

// 配置 4x4 MIMO (支援的模組)
AT+QMIMO=1,4
```

##### QoS 配置優化
```at
// 設定高優先級 QoS
AT+QCFG="qos",1,1

// 配置低延遲模式
AT+QCFG="latency",1
```

##### PDCP 層優化

###### 標頭壓縮優化
```at
// 啟用動態壓縮提升效率
AT+QPDCP=1,2,3

// 配置最佳壓縮協議
AT+QPDCP=1,2,2  // IP/UDP 壓縮

// 監控壓縮效率
AT+QPDCPEFF
```

###### 加密優化
```at
// 使用高效加密算法
AT+QENCRYPT=1,1,1  // AES + 完整性保護

// 配置序列號大小
AT+QPDCPSN=12,500  // 12位元 + 500ms 重排序
```

##### RLC 層優化

###### 視窗大小優化
```at
// 根據網路品質調整視窗大小
AT+QRLCWIN=4096,4096,1000  // 大視窗 + 長計時器

// 動態調整分段大小
AT+QRLCSEG=1500,100,1  // 動態分段
```

###### 模式選擇優化
```at
// 即時應用使用 UM 模式
AT+QRLC=2,1024,1000  // UM + 小視窗 + 短計時器

// 可靠傳輸使用 AM 模式
AT+QRLC=3,2048,2000,500  // AM + 大視窗 + 長計時器
```

#### 降低功耗
1. **PSM (Power Saving Mode)**: `AT+CPSMS=1`
2. **eDRX (Extended Discontinuous Reception)**: `AT+CEDRXS=1`
3. **適當的資料傳輸間隔**
4. **使用 UDP 而非 TCP**（適用場景）

#### 提高傳輸效率
1. **適當的封包大小**
2. **使用壓縮**: `AT+QHTTPCFG="compress",1`
3. **連接池管理**
4. **非同步處理**

### 除錯技巧

#### 啟用除錯模式
```at
// 啟用詳細錯誤訊息
AT+CMEE=2

// 啟用 AT 指令回顯
ATE1

// 查看模組狀態
AT+CPAS
```

#### 常用除錯指令
```at
// 檢查模組版本
AT+CGMR

// 檢查 IMEI
AT+CGSN=1

// 檢查 SIM 卡資訊
AT+CCID

// 檢查訊號品質
AT+CSQ

// 檢查網路註冊狀態
AT+CREG?

// 檢查 PDP 上下文狀態
AT+CGATT?
```

## 總結

本教學指南涵蓋了在 Quectel 模組上實作 TCP/IP 協議的完整知識體系，從基礎的網路架構到進階的應用層協議。透過深入理解這些協議的特性和實作方式，您將能夠：

1. **選擇合適的協議**: 根據應用需求選擇 TCP、UDP、MQTT 等
2. **優化網路效能**: 透過適當的配置和調優提升傳輸效率
3. **確保通訊安全**: 使用 TLS/HTTPS 保護資料傳輸
4. **解決常見問題**: 快速診斷和解決網路連接問題

隨著 5G 技術的發展和物聯網應用的普及，Quectel 模組將在更多場景中發揮重要作用。持續學習和實踐將幫助您掌握這些技術，並在實際專案中取得成功。

---

**參考資源**:
- [Quectel 官方文檔](https://www.quectel.com/support)
- [RFC 文檔](https://tools.ietf.org/rfc/)
- [MQTT 協議規範](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html)
- [WebSocket 協議規範](https://tools.ietf.org/html/rfc6455) 