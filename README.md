# Quectel 模組 TCP/IP 協議教學指南

## 目錄
- [概述](#概述)
- [網路基礎架構](#網路基礎架構)
  - [OSI 七層模型與 TCP/IP 四層模型](#osi-七層模型與-tcpip-四層模型)
  - [MAC 層 (Media Access Control)](#mac-層-media-access-control)
    - [MAC 層主要功能](#mac-層主要功能)
    - [蜂窩網路資料鏈路層架構](#蜂窩網路資料鏈路層架構)
    - [MAC 層協議類型](#mac-層協議類型)
    - [MAC 幀結構](#mac-幀結構)
    - [MAC 層關鍵機制](#mac-層關鍵機制)
  - [PDCP (Packet Data Convergence Protocol)](#pdcp-packet-data-convergence-protocol)
    - [PDCP 層功能](#pdcp-層功能)
    - [PDCP 架構](#pdcp-架構)
    - [PDCP 封包結構](#pdcp-封包結構)
    - [PDCP 關鍵機制](#pdcp-關鍵機制)
  - [RLC (Radio Link Control)](#rlc-radio-link-control)
    - [RLC 層功能](#rlc-層功能)
    - [RLC 架構](#rlc-架構)
    - [RLC 封包結構](#rlc-封包結構)
    - [RLC 傳輸模式](#rlc-傳輸模式)
    - [RLC 關鍵機制](#rlc-關鍵機制)
  - [PPP (Point-to-Point Protocol)](#ppp-point-to-point-protocol)
    - [PPP 基本概念](#ppp-基本概念)
    - [PPP 架構](#ppp-架構)
    - [PPP 封包結構](#ppp-封包結構)
    - [PPP 配置範例](#ppp-配置範例)
- [IP 協議詳解](#ip-協議詳解)
  - [IPv4 協議](#ipv4-協議)
    - [IPv4 地址結構](#ipv4-地址結構)
    - [IPv4 地址分類](#ipv4-地址分類)
    - [IPv4 封包結構](#ipv4-封包結構)
    - [IPv4 子網路遮罩原理](#ipv4-子網路遮罩原理)
  - [IPv6 協議](#ipv6-協議)
    - [IPv6 地址結構](#ipv6-地址結構)
    - [IPv6 地址類型](#ipv6-地址類型)
    - [IPv6 在區域網路中的使用](#ipv6-在區域網路中的使用)
    - [IPv6 與 IPv4 區域網路比較](#ipv6-與-ipv4-區域網路比較)
    - [IPv6 封包結構](#ipv6-封包結構)
  - [VLAN (Virtual Local Area Network) 虛擬區域網路](#vlan-virtual-local-area-network-虛擬區域網路)
    - [VLAN 基本概念](#vlan-基本概念)
    - [VLAN 類型與配置](#vlan-類型與配置)
    - [網路管理員如何使用 VLAN](#網路管理員如何使用-vlan)
    - [不同網路串接成區域網路](#不同網路串接成區域網路)
    - [VLAN 監控與管理](#vlan-監控與管理)
    - [VLAN 故障排除](#vlan-故障排除)
  - [IPv4 與 IPv6 轉換](#ipv4-與-ipv6-轉換)
    - [雙堆疊 (Dual Stack)](#雙堆疊-dual-stack)
    - [隧道技術 (Tunneling)](#隧道技術-tunneling)
    - [轉換技術 (Translation)](#轉換技術-translation)
  - [Local IP vs Global IP](#local-ip-vs-global-ip)
    - [Local IP 概念](#local-ip-概念)
    - [Global IP 概念](#global-ip-概念)
    - [NAT (Network Address Translation)](#nat-network-address-translation)
- [傳輸層協議](#傳輸層協議)
  - [TCP (Transmission Control Protocol)](#tcp-transmission-control-protocol)
    - [TCP 特性](#tcp-特性)
    - [TCP 封包結構](#tcp-封包結構)
    - [TCP 連接狀態機](#tcp-連接狀態機)
    - [TCP 應用場景](#tcp-應用場景)
  - [UDP (User Datagram Protocol)](#udp-user-datagram-protocol)
    - [UDP 特性](#udp-特性)
    - [UDP 封包結構](#udp-封包結構)
    - [UDP 應用場景](#udp-應用場景)
- [應用層協議](#應用層協議)
  - [MQTT (Message Queuing Telemetry Transport)](#mqtt-message-queuing-telemetry-transport)
    - [MQTT 特性](#mqtt-特性)
    - [MQTT 封包類型](#mqtt-封包類型)
    - [MQTT 應用場景](#mqtt-應用場景)
  - [WebSocket](#websocket)
    - [WebSocket 特性](#websocket-特性)
    - [WebSocket 握手過程](#websocket-握手過程)
    - [WebSocket 幀格式](#websocket-幀格式)
    - [WebSocket 應用場景](#websocket-應用場景)
  - [QUIC (Quick UDP Internet Connections)](#quic-quick-udp-internet-connections)
    - [QUIC 特性](#quic-特性)
    - [QUIC 連接建立](#quic-連接建立)
    - [QUIC 應用場景](#quic-應用場景)
- [安全協議](#安全協議)
  - [TLS (Transport Layer Security)](#tls-transport-layer-security)
    - [TLS 版本](#tls-版本)
    - [TLS 握手過程](#tls-握手過程)
    - [TLS 加密套件](#tls-加密套件)
  - [HTTPS (HTTP Secure)](#https-http-secure)
    - [HTTPS 特性](#https-特性)
    - [HTTPS 證書類型](#https-證書類型)
    - [HTTPS 應用場景](#https-應用場景)
- [Quectel 模組實作範例](#quectel-模組實作範例)
  - [MAC 層配置與支援](#mac-層配置與支援)
    - [網路模式配置](#網路模式配置)
    - [註冊與功率控制](#註冊與功率控制)
    - [PPP 連接配置](#ppp-連接配置)
    - [效能監控與調試](#效能監控與調試)
    - [進階功能配置](#進階功能配置)
  - [PDCP 層配置](#pdcp-層配置)
    - [PDCP 基本配置](#pdcp-基本配置)
    - [ROHC 壓縮配置](#rohc-壓縮配置)
    - [加密與完整性保護](#加密與完整性保護)
    - [PDCP 效能監控](#pdcp-效能監控)
  - [RLC 層配置](#rlc-層配置)
    - [RLC 模式配置](#rlc-模式配置)
    - [視窗大小配置](#視窗大小配置)
    - [分段與重組配置](#分段與重組配置)
    - [RLC 效能監控](#rlc-效能監控)
  - [IP 配置與支援](#ip-配置與支援)
    - [IPv4 子網路配置](#ipv4-子網路配置)
    - [IPv6 配置](#ipv6-配置)
    - [雙堆疊配置](#雙堆疊配置)
    - [IP 層效能監控](#ip-層效能監控)
  - [VLAN 配置與支援](#vlan-配置與支援)
    - [VLAN 基本配置](#vlan-基本配置)
    - [VLAN 間路由配置](#vlan-間路由配置)
    - [VLAN 安全配置](#vlan-安全配置)
    - [VLAN 監控與診斷](#vlan-監控與診斷)
  - [TCP/UDP 實作](#tcpudp-實作)
    - [TCP 連接管理](#tcp-連接管理)
    - [UDP 資料傳輸](#udp-資料傳輸)
    - [Socket 配置](#socket-配置)
  - [MQTT 實作](#mqtt-實作)
    - [MQTT 連接建立](#mqtt-連接建立)
    - [MQTT 訊息發布與訂閱](#mqtt-訊息發布與訂閱)
    - [MQTT QoS 配置](#mqtt-qos-配置)
  - [HTTPS/WebSocket 實作](#httpswebsocket-實作)
    - [HTTPS 連接建立](#https-連接建立)
    - [WebSocket 連接建立](#websocket-連接建立)
    - [SSL/TLS 配置](#ssltls-配置)
  - [電源管理](#電源管理)
    - [PSM (Power Saving Mode)](#psm-power-saving-mode)
    - [eDRX (Extended Discontinuous Reception)](#edrx-extended-discontinuous-reception)
    - [省電模式配置](#省電模式配置)
- [效能優化](#效能優化)
  - [MAC 層效能優化](#mac-層效能優化)
    - [傳輸功率優化](#傳輸功率優化)
    - [通道選擇優化](#通道選擇優化)
    - [MIMO 配置優化](#mimo-配置優化)
    - [QoS 配置優化](#qos-配置優化)
  - [PDCP 層優化](#pdcp-層優化)
    - [ROHC 壓縮優化](#rohc-壓縮優化)
    - [加密算法優化](#加密算法優化)
    - [序列號管理優化](#序列號管理優化)
  - [RLC 層優化](#rlc-層優化)
    - [視窗大小優化](#視窗大小優化)
    - [模式選擇優化](#模式選擇優化)
    - [重傳機制優化](#重傳機制優化)
  - [IP 層效能優化](#ip-層效能優化)
    - [IPv4 子網路優化](#ipv4-子網路優化)
    - [IPv6 配置優化](#ipv6-配置優化)
    - [雙堆疊效能優化](#雙堆疊效能優化)
    - [IP 層監控與調優](#ip-層監控與調優)
  - [VLAN 效能優化](#vlan-效能優化)
    - [VLAN 配置優化](#vlan-配置優化)
    - [VLAN 間路由優化](#vlan-間路由優化)
    - [VLAN 安全優化](#vlan-安全優化)
    - [VLAN 監控優化](#vlan-監控優化)
- [常見問題與故障排除](#常見問題與故障排除)
  - [MAC 層問題](#mac-層問題)
    - [網路註冊失敗](#網路註冊失敗)
    - [傳輸錯誤](#傳輸錯誤)
    - [PPP 連接失敗](#ppp-連接失敗)
  - [PDCP 層問題](#pdcp-層問題)
    - [壓縮失敗](#壓縮失敗)
    - [加密錯誤](#加密錯誤)
    - [序列號錯誤](#序列號錯誤)
  - [RLC 層問題](#rlc-層問題)
    - [重傳失敗](#重傳失敗)
    - [分段錯誤](#分段錯誤)
    - [視窗溢出](#視窗溢出)
  - [IPv4 子網路配置問題](#ipv4-子網路配置問題)
    - [子網路遮罩配置錯誤](#子網路遮罩配置錯誤)
    - [廣播域問題](#廣播域問題)
    - [靜態 IP 衝突](#靜態-ip-衝突)
  - [IPv6 配置問題](#ipv6-配置問題)
    - [自動配置失敗](#自動配置失敗)
    - [前綴錯誤](#前綴錯誤)
    - [雙堆疊問題](#雙堆疊問題)
    - [Link-Local 地址問題](#link-local-地址問題)
  - [VLAN 配置問題](#vlan-配置問題)
    - [VLAN 間無法通訊](#vlan-間無法通訊)
    - [VLAN 標籤問題](#vlan-標籤問題)
    - [VLAN 安全策略問題](#vlan-安全策略問題)
  - [TCP/UDP 問題](#tcpudp-問題)
    - [TCP 連接失敗](#tcp-連接失敗)
    - [UDP 資料丟失](#udp-資料丟失)
    - [Socket 配置錯誤](#socket-配置錯誤)
  - [MQTT 問題](#mqtt-問題)
    - [MQTT 連接失敗](#mqtt-連接失敗)
    - [訊息發布失敗](#訊息發布失敗)
    - [QoS 配置錯誤](#qos-配置錯誤)
  - [HTTPS/WebSocket 問題](#httpswebsocket-問題)
    - [SSL/TLS 握手失敗](#ssltls-握手失敗)
    - [證書驗證錯誤](#證書驗證錯誤)
    - [WebSocket 升級失敗](#websocket-升級失敗)
- [總結](#總結)

## 概述

本教學指南專為在 Quectel 模組上實作 TCP/IP 協議而設計，涵蓋從 MAC 層到應用層的完整網路協議棧。Quectel 模組（如 EC20、EG91、BG95 等）提供了強大的蜂窩網路連接能力，支援多種網路協議和應用場景。

### Quectel 模組特色
- **多模支援**: 支援 2G/3G/4G/5G 網路
- **豐富協議**: 內建 TCP/UDP/MQTT/HTTP/HTTPS 等協議
- **低功耗**: 優化的電源管理
- **高可靠性**: 工業級設計標準
- **易於整合**: 標準 AT 指令集

## 網路基礎架構

### OSI 七層模型與 TCP/IP 四層模型

```
應用層 (Application Layer)
    ↓
傳輸層 (Transport Layer)     ← TCP/UDP
    ↓
網路層 (Network Layer)       ← IP (IPv4/IPv6)
    ↓
資料鏈路層 (Data Link Layer) ← MAC/PPP
    ↓
實體層 (Physical Layer)      ← 蜂窩網路
```

### MAC 層 (Media Access Control)

MAC 層是資料鏈路層的子層，負責控制資料在實體媒介上的傳輸。在蜂窩網路中，MAC 層扮演著關鍵角色，管理無線資源分配和資料傳輸控制。

#### MAC 層主要功能

1. **媒體訪問控制**: 管理多個設備如何共享無線頻道
2. **資料封裝**: 將上層資料封裝成 MAC 幀
3. **錯誤檢測**: 提供基本的錯誤檢測機制
4. **流量控制**: 控制資料傳輸速率
5. **優先級管理**: 處理不同優先級的資料傳輸

#### 蜂窩網路資料鏈路層架構

```
┌─────────────────────────────────────────────────────────────┐
│ 應用層 (Application Layer)                                 │
├─────────────────────────────────────────────────────────────┤
│ 傳輸層 (Transport Layer) - TCP/UDP                        │
├─────────────────────────────────────────────────────────────┤
│ 網路層 (Network Layer) - IP                               │
├─────────────────────────────────────────────────────────────┤
│ 資料鏈路層 (Data Link Layer)                              │
│ ├── PDCP (Packet Data Convergence Protocol) ← 新增重點    │
│ ├── RLC (Radio Link Control) ← 新增重點                   │
│ └── MAC (Media Access Control) ← 本層重點                 │
├─────────────────────────────────────────────────────────────┤
│ 實體層 (Physical Layer) - 無線電傳輸                      │
└─────────────────────────────────────────────────────────────┘
```

#### MAC 層協議類型

##### 1. LTE MAC (Long Term Evolution)
- **下行 MAC**: 從基地台到設備的資料傳輸
- **上行 MAC**: 從設備到基地台的資料傳輸
- **排程機制**: 動態資源分配
- **HARQ**: 混合自動重傳請求

##### 2. 5G NR MAC (New Radio)
- **靈活排程**: 更靈活的時隙配置
- **多波束**: 支援波束成形
- **低延遲**: 支援 URLLC 應用
- **大規模 MIMO**: 多天線技術

##### 3. 2G/3G MAC
- **GSM MAC**: 時分多址 (TDMA)
- **WCDMA MAC**: 碼分多址 (CDMA)
- **GPRS MAC**: 分組資料傳輸

#### MAC 幀結構

```
┌─────────────────────────────────────────────────────────────┐
│ MAC 標頭 (MAC Header)                                      │
│ ├── 控制欄位 (Control Fields)                              │
│ ├── 地址欄位 (Address Fields)                              │
│ └── 長度欄位 (Length Field)                                │
├─────────────────────────────────────────────────────────────┤
│ MAC 載荷 (MAC Payload)                                     │
│ ├── 邏輯通道 ID (Logical Channel ID)                       │
│ ├── 序列號 (Sequence Number)                               │
│ └── 資料 (Data)                                            │
├─────────────────────────────────────────────────────────────┤
│ MAC 尾部 (MAC Trailer)                                     │
│ └── 校驗和 (Checksum)                                      │
└─────────────────────────────────────────────────────────────┘
```

#### MAC 層關鍵機制

##### 1. 資源排程 (Resource Scheduling)
```
基地台排程器
    ↓
分配無線資源
    ↓
MAC 層處理
    ↓
實體層傳輸
```

##### 2. 邏輯通道 (Logical Channels)
- **控制通道**: 傳輸控制資訊
- **業務通道**: 傳輸用戶資料
- **廣播通道**: 系統廣播資訊

##### 3. 傳輸格式組合 (Transport Format Combination)
- 定義資料傳輸的格式和參數
- 包括調製方式、編碼率、傳輸塊大小等

#### PPP (Point-to-Point Protocol)

PPP 是在點對點連接上傳輸多協議資料包的標準方法，在蜂窩網路中廣泛使用。

##### PPP 層結構
```
┌─────────────────────────────────────────────────────────────┐
│ IP 封包 (IP Packet)                                        │
├─────────────────────────────────────────────────────────────┤
│ PPP 載荷 (PPP Payload)                                     │
├─────────────────────────────────────────────────────────────┤
│ PPP 標頭 (PPP Header)                                      │
│ ├── 標誌 (Flag) - 0x7E                                     │
│ ├── 地址 (Address) - 0xFF                                  │
│ ├── 控制 (Control) - 0x03                                  │
│ └── 協議 (Protocol) - 0x0021 (IPv4)                       │
└─────────────────────────────────────────────────────────────┘
```

##### PPP 協議類型
| 協議 | 值 | 用途 |
|------|----|------|
| IPv4 | 0x0021 | Internet Protocol v4 |
| IPv6 | 0x0057 | Internet Protocol v6 |
| LCP | 0xC021 | Link Control Protocol |
| NCP | 0x8021 | Network Control Protocol |
| CHAP | 0xC223 | Challenge Handshake Authentication Protocol |
| PAP | 0xC023 | Password Authentication Protocol |

##### PPP 連接階段
```
1. 鏈路建立 (Link Establishment)
   ↓
2. 認證 (Authentication) - 可選
   ↓
3. 網路層配置 (Network Layer Configuration)
   ↓
4. 資料傳輸 (Data Transfer)
   ↓
5. 鏈路終止 (Link Termination)
```

### PDCP (Packet Data Convergence Protocol)

PDCP 層位於 RLC 層之上，負責處理 IP 封包的壓縮、加密和完整性保護。

#### PDCP 層主要功能

1. **IP 標頭壓縮**: 減少 IP 標頭開銷
2. **資料加密**: 提供資料機密性保護
3. **完整性保護**: 防止資料篡改
4. **重排序**: 處理重傳封包的順序
5. **重複檢測**: 避免重複封包處理

#### PDCP 層架構

```
┌─────────────────────────────────────────────────────────────┐
│ PDCP 層 (Packet Data Convergence Protocol)                │
│ ├── 控制平面 (Control Plane)                               │
│ │   ├── RRC 訊息處理                                       │
│ │   └── 控制訊息加密                                       │
│ └── 用戶平面 (User Plane)                                  │
│     ├── IP 封包處理                                        │
│     ├── 標頭壓縮                                           │
│     └── 資料加密                                           │
└─────────────────────────────────────────────────────────────┘
```

#### PDCP 封包結構

```
┌─────────────────────────────────────────────────────────────┐
│ PDCP 標頭 (PDCP Header)                                    │
│ ├── D/C 位元 (Data/Control)                               │
│ ├── 序列號 (Sequence Number) - 12位元                      │
│ └── 保留位元 (Reserved Bits)                              │
├─────────────────────────────────────────────────────────────┤
│ PDCP 載荷 (PDCP Payload)                                   │
│ ├── 壓縮標頭 (Compressed Header) - 可選                    │
│ ├── 加密資料 (Encrypted Data)                              │
│ └── 完整性保護 (Integrity Protection) - 可選               │
└─────────────────────────────────────────────────────────────┘
```

#### PDCP 標頭壓縮

##### ROHC (Robust Header Compression)
- **IP/UDP/RTP 壓縮**: 減少即時通訊開銷
- **IP/TCP 壓縮**: 減少一般資料傳輸開銷
- **IP 壓縮**: 僅壓縮 IP 標頭

##### 壓縮模式
| 模式 | 描述 | 適用場景 |
|------|------|----------|
| 非壓縮 | 不進行壓縮 | 測試環境 |
| 靜態壓縮 | 壓縮靜態欄位 | 一般應用 |
| 動態壓縮 | 壓縮動態欄位 | 即時通訊 |

#### PDCP 加密與完整性保護

##### 加密算法
- **AES**: 進階加密標準
- **SNOW 3G**: 3GPP 標準加密算法
- **ZUC**: 中國標準加密算法

##### 完整性保護
- **HMAC-SHA-256**: 基於 SHA-256 的完整性保護
- **AES-CMAC**: 基於 AES 的完整性保護

### RLC (Radio Link Control)

RLC 層位於 PDCP 層和 MAC 層之間，負責資料分段、重組和錯誤恢復。

#### RLC 層主要功能

1. **分段與重組**: 將大封包分段傳輸
2. **錯誤檢測**: 檢測傳輸錯誤
3. **重傳機制**: 自動重傳錯誤封包
4. **流量控制**: 控制資料傳輸速率
5. **序列號管理**: 確保封包順序

#### RLC 層模式

##### 1. TM (Transparent Mode) - 透明模式
- **特點**: 不進行分段或重組
- **適用**: 廣播/多播資料
- **開銷**: 最小
- **可靠性**: 無錯誤恢復

##### 2. UM (Unacknowledged Mode) - 非確認模式
- **特點**: 分段但不重傳
- **適用**: 即時應用 (VoIP, 視訊)
- **開銷**: 中等
- **可靠性**: 有限錯誤恢復

##### 3. AM (Acknowledged Mode) - 確認模式
- **特點**: 分段且重傳
- **適用**: 可靠資料傳輸
- **開銷**: 最大
- **可靠性**: 完整錯誤恢復

#### RLC 封包結構

```
┌─────────────────────────────────────────────────────────────┐
│ RLC 標頭 (RLC Header)                                      │
│ ├── 模式識別 (Mode Identifier)                             │
│ ├── 序列號 (Sequence Number)                               │
│ ├── 分段資訊 (Segmentation Info)                           │
│ └── 長度指示器 (Length Indicator)                          │
├─────────────────────────────────────────────────────────────┤
│ RLC 載荷 (RLC Payload)                                     │
│ ├── 資料段 (Data Segment)                                  │
│ └── 填充 (Padding) - 可選                                  │
└─────────────────────────────────────────────────────────────┘
```

#### RLC 層關鍵機制

##### 1. 分段與重組
```
原始封包 (1500 bytes)
    ↓
分段 1 (500 bytes) + 分段 2 (500 bytes) + 分段 3 (500 bytes)
    ↓
傳輸
    ↓
重組 → 原始封包 (1500 bytes)
```

##### 2. 滑動視窗機制
```
發送視窗: [1, 2, 3, 4, 5, 6, 7, 8]
接收視窗: [1, 2, 3, 4, 5, 6, 7, 8]
    ↓
收到 ACK 3
    ↓
發送視窗: [4, 5, 6, 7, 8, 9, 10, 11]
```

##### 3. 重傳機制
```
發送封包 1, 2, 3, 4, 5
    ↓
接收方回應: ACK 1, NACK 2, ACK 3, ACK 4, ACK 5
    ↓
重傳封包 2
    ↓
接收方回應: ACK 2
```

#### RLC 層效能參數

##### 視窗大小配置
- **發送視窗大小**: 控制發送緩衝區
- **接收視窗大小**: 控制接收緩衝區
- **重傳計時器**: 控制重傳延遲

##### 分段大小配置
- **最大分段大小**: 影響傳輸效率
- **最小分段大小**: 影響開銷
- **動態分段**: 根據網路狀況調整

## IP 協議詳解

### IPv4 (Internet Protocol Version 4)

#### IPv4 地址結構
```
32位元地址 = 網路部分 + 主機部分
例如: 192.168.1.100
```

#### IPv4 子網路遮罩 (Subnet Mask) 原理

子網路遮罩是 IPv4 網路中的核心概念，用於區分網路部分和主機部分。

##### 子網路遮罩基本概念
```
子網路遮罩: 255.255.255.0 (二進位: 11111111.11111111.11111111.00000000)
IP 地址:    192.168.1.100 (二進位: 11000000.10101000.00000001.01100100)
網路地址:   192.168.1.0   (透過 AND 運算得出)
```

##### 子網路遮罩運算原理
1. **AND 運算**: IP 地址與子網路遮罩進行位元 AND 運算
2. **網路地址**: 運算結果即為網路地址
3. **主機範圍**: 遮罩中 0 的部分為可用的主機地址

##### 常見子網路遮罩
| 遮罩 | 二進位表示 | 可用主機數 | 用途 |
|------|------------|------------|------|
| /24 | 255.255.255.0 | 254 | 小型網路 |
| /16 | 255.255.0.0 | 65,534 | 中型網路 |
| /8 | 255.0.0.0 | 16,777,214 | 大型網路 |
| /30 | 255.255.255.252 | 2 | 點對點連接 |
| /32 | 255.255.255.255 | 1 | 單一主機 |

##### 網路管理員如何管理區段

###### 1. 子網路劃分 (Subnetting)
```
原始網路: 192.168.0.0/16
劃分為:
- 192.168.1.0/24 (銷售部門)
- 192.168.2.0/24 (研發部門)
- 192.168.3.0/24 (行政部門)
```

###### 2. 廣播域管理
- **廣播封包**: 發送到網路內所有主機
- **廣播地址**: 網路地址的最後一個地址 (如 192.168.1.255)
- **減少廣播範圍**: 透過子網路劃分限制廣播封包的影響範圍

###### 3. 網路分段策略
```
企業網路架構:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 管理網路        │  │ 生產網路        │  │ 訪客網路        │
│ 10.1.0.0/24     │  │ 10.2.0.0/24     │  │ 10.3.0.0/24     │
│ 廣播域: 254台   │  │ 廣播域: 254台   │  │ 廣播域: 254台   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

##### 子網路計算範例

###### 範例 1: 基本子網路劃分
```
需求: 將 192.168.0.0/24 劃分為 4 個子網路
計算:
- 需要 2 位元來表示 4 個子網路 (2² = 4)
- 新的子網路遮罩: /26 (24 + 2 = 26)
- 子網路遮罩: 255.255.255.192

結果:
- 192.168.0.0/26 (0-63)
- 192.168.0.64/26 (64-127)
- 192.168.0.128/26 (128-191)
- 192.168.0.192/26 (192-255)
```

###### 範例 2: VLSM (可變長度子網路遮罩)
```
需求: 不同部門需要不同數量的主機
- 研發部: 100 台主機
- 銷售部: 50 台主機
- 行政部: 25 台主機

解決方案:
- 研發部: 192.168.1.0/25 (126 台主機)
- 銷售部: 192.168.1.128/26 (62 台主機)
- 行政部: 192.168.1.192/27 (30 台主機)
```

##### 廣播域優化

###### 1. 廣播風暴防護
- **限制廣播範圍**: 透過路由器隔離廣播域
- **廣播抑制**: 設定廣播封包速率限制
- **網路監控**: 監控廣播流量異常

###### 2. 效能優化
```
廣播域大小對效能的影響:
- 小型廣播域 (≤ 254 台): 高效能，低延遲
- 中型廣播域 (255-1024 台): 中等效能
- 大型廣播域 (> 1024 台): 效能下降，建議分割
```

###### 3. 安全性考量
- **網路隔離**: 不同部門使用不同子網路
- **存取控制**: 基於子網路的防火牆規則
- **監控**: 子網路層級的流量監控

#### IPv4 地址分類
| 類別 | 範圍 | 預設子網路遮罩 | 用途 |
|------|------|----------------|------|
| A | 1.0.0.0 - 126.255.255.255 | 255.0.0.0 | 大型網路 |
| B | 128.0.0.0 - 191.255.255.255 | 255.255.0.0 | 中型網路 |
| C | 192.0.0.0 - 223.255.255.255 | 255.255.255.0 | 小型網路 |
| D | 224.0.0.0 - 239.255.255.255 | - | 多播 |
| E | 240.0.0.0 - 255.255.255.255 | - | 保留 |

#### IPv4 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ IHL │ 服務類型 │ 總長度                               │
├─────────────────────────────────────────────────────────────┤
│ 識別碼 │ 標誌 │ 分段偏移                                   │
├─────────────────────────────────────────────────────────────┤
│ TTL │ 協議 │ 標頭校驗和                                   │
├─────────────────────────────────────────────────────────────┤
│ 來源 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 目標 IP 地址                                                │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv6 (Internet Protocol Version 6)

#### IPv6 地址結構
```
128位元地址，以16進位表示，用冒號分隔
例如: 2001:0db8:85a3:0000:0000:8a2e:0370:7334
簡化: 2001:db8:85a3::8a2e:370:7334
```

#### IPv6 地址類型
| 類型 | 前綴 | 用途 |
|------|------|------|
| 全域單播 | 2000::/3 | 全域路由 |
| 唯一本地 | fc00::/7 | 私有網路 |
| 鏈路本地 | fe80::/10 | 本地鏈路 |
| 多播 | ff00::/8 | 多播通訊 |
| 回環 | ::1/128 | 本地回環 |

#### IPv6 在區域網路中的使用

##### IPv6 區域網路架構
IPv6 完全支援區域網路使用，並提供比 IPv4 更豐富的地址類型和更好的網路管理能力。

###### 1. IPv6 區域網路地址類型

**鏈路本地地址 (Link-Local Address)**
```
格式: fe80::[介面識別碼]/64
範例: fe80::1a2b:3c4d:5e6f:7890/64
用途: 同一鏈路上的設備通訊
特點: 自動配置，無需路由器
```

**唯一本地地址 (Unique Local Address, ULA)**
```
格式: fd00::/8 或 fc00::/8
範例: fd00:1234:5678::/48
用途: 私有網路內部通訊
特點: 全域唯一，可路由，但不會洩露到網際網路
```

**全域單播地址 (Global Unicast Address)**
```
格式: 2000::/3
範例: 2001:db8:1234:5678::/64
用途: 網際網路通訊
特點: 全域路由，需要 ISP 分配
```

###### 2. IPv6 區域網路配置範例

```
企業 IPv6 區域網路架構:
┌─────────────────────────────────────────────────────────────┐
│ 管理網路                                                    │
│ fd00:1:2:3::/64 (唯一本地)                                 │
│ fe80::1:2:3:4/64 (鏈路本地)                                │
├─────────────────────────────────────────────────────────────┤
│ 生產網路                                                    │
│ fd00:1:2:4::/64 (唯一本地)                                 │
│ fe80::1:2:4:5/64 (鏈路本地)                                │
├─────────────────────────────────────────────────────────────┤
│ 訪客網路                                                    │
│ fd00:1:2:5::/64 (唯一本地)                                 │
│ fe80::1:2:5:6/64 (鏈路本地)                                │
└─────────────────────────────────────────────────────────────┘
```

##### IPv6 子網路概念 (Subnetting)

###### IPv6 是否有 "遮罩" 概念？

IPv6 **沒有傳統的子網路遮罩**，但使用**前綴長度 (Prefix Length)** 來表示網路部分。

###### 1. IPv6 前綴長度表示法
```
IPv4 表示法: 192.168.1.0/24
IPv6 表示法: 2001:db8:1234:5678::/64

前綴長度說明:
- /64: 標準子網路大小 (2^64 個主機地址)
- /48: 大型網路 (2^80 個主機地址)
- /56: 中型網路 (2^72 個主機地址)
- /128: 單一主機地址
```

###### 2. IPv6 子網路劃分原理

**基本概念**
```
IPv6 地址: 2001:db8:1234:5678:9abc:def0:1234:5678
前綴長度: /64
網路部分: 2001:db8:1234:5678::
主機部分: 9abc:def0:1234:5678
```

**子網路劃分範例**
```
原始網路: 2001:db8:1234::/48
劃分為 256 個 /64 子網路:

2001:db8:1234:0000::/64 (子網路 0)
2001:db8:1234:0001::/64 (子網路 1)
2001:db8:1234:0002::/64 (子網路 2)
...
2001:db8:1234:00ff::/64 (子網路 255)
```

###### 3. IPv6 區域網路子網路規劃

**企業 IPv6 子網路規劃**
```
總部網路: 2001:db8:1234:0000::/64
分支網路: 2001:db8:1234:0001::/64
DMZ 網路: 2001:db8:1234:0002::/64
管理網路: 2001:db8:1234:0003::/64
訪客網路: 2001:db8:1234:0004::/64
```

**IPv6 子網路計算工具**
```bash
# 計算 IPv6 子網路範圍
ipv6calc --in ipv6addr --out ipv6addr 2001:db8:1234:5678::/64

# 驗證 IPv6 地址是否在子網路內
ipv6calc --in ipv6addr --out ipv6addr 2001:db8:1234:5678::1
```

##### IPv6 區域網路優勢

###### 1. 地址空間優勢
- **龐大地址空間**: 每個子網路有 2^64 個地址
- **無需 NAT**: 每個設備都有全域唯一地址
- **簡化網路架構**: 減少網路地址轉換複雜度

###### 2. 自動配置能力
```
無狀態地址自動配置 (SLAAC):
1. 路由器發送 RA (Router Advertisement)
2. 主機自動生成介面識別碼
3. 組合形成完整 IPv6 地址
4. 無需 DHCP 伺服器
```

###### 3. 安全性增強
- **隱私擴展**: 定期變更介面識別碼
- **內建 IPSec**: 端到端加密支援
- **更細粒度控制**: 基於地址的安全策略

##### IPv6 與 IPv4 區域網路比較

| 特性 | IPv4 | IPv6 |
|------|------|------|
| 地址空間 | 32位元 | 128位元 |
| 子網路遮罩 | 有 | 前綴長度 |
| 自動配置 | DHCP | SLAAC + DHCPv6 |
| NAT | 必需 | 可選 |
| 安全性 | 外掛 | 內建 |
| 多播 | 支援 | 增強支援 |

#### VLAN (Virtual Local Area Network) 虛擬區域網路

VLAN 是一種網路虛擬化技術，允許網路管理員在單一實體網路基礎設施上創建多個邏輯網路。

##### VLAN 基本概念

###### 1. VLAN 定義與目的
```
VLAN 是一種邏輯網路分段技術，允許將單一實體網路分割為多個虛擬網路。

目的:
- 網路分段與隔離
- 廣播域控制
- 安全性提升
- 網路管理簡化
- 頻寬優化
```

###### 2. VLAN 標籤 (Tag) 結構
```
IEEE 802.1Q VLAN 標籤格式:
┌─────────────────────────────────────────────────────────────┐
│ 目的 MAC (6 bytes) │ 來源 MAC (6 bytes) │ 類型 (2 bytes) │
├─────────────────────────────────────────────────────────────┤
│ VLAN 標籤 (4 bytes)                                        │
│ ├── TPID (2 bytes): 0x8100                                │
│ ├── TCI (2 bytes)                                         │
│ │   ├── Priority (3 bits): 優先級                         │
│ │   ├── CFI (1 bit): 規範格式指示器                       │
│ │   └── VID (12 bits): VLAN ID (1-4094)                   │
│ └───────────────────────────────────────────────────────────┘
│ 資料 (46-1500 bytes)                                       │
└─────────────────────────────────────────────────────────────┘
```

##### VLAN 類型與配置

###### 1. VLAN 類型
```
基於端口的 VLAN (Port-based VLAN):
- 根據交換機端口分配 VLAN
- 簡單易配置
- 適合固定設備

基於 MAC 地址的 VLAN (MAC-based VLAN):
- 根據設備 MAC 地址分配 VLAN
- 設備移動時 VLAN 跟隨
- 適合移動設備

基於協議的 VLAN (Protocol-based VLAN):
- 根據網路協議分配 VLAN
- 支援多協議環境
- 適合混合網路

基於子網路的 VLAN (Subnet-based VLAN):
- 根據 IP 子網路分配 VLAN
- 與 IP 規劃結合
- 適合大型網路
```

###### 2. VLAN 配置範例
```
企業 VLAN 規劃:
┌─────────────────────────────────────────────────────────────┐
│ VLAN 10: 管理網路 (Management)                             │
│ - 範圍: 192.168.10.0/24                                   │
│ - 設備: 網路設備、伺服器管理介面                           │
│ - 安全等級: 高                                             │
├─────────────────────────────────────────────────────────────┤
│ VLAN 20: 生產網路 (Production)                             │
│ - 範圍: 192.168.20.0/24                                   │
│ - 設備: 生產設備、工業控制系統                             │
│ - 安全等級: 中                                             │
├─────────────────────────────────────────────────────────────┤
│ VLAN 30: 辦公網路 (Office)                                 │
│ - 範圍: 192.168.30.0/24                                   │
│ - 設備: 辦公電腦、印表機                                   │
│ - 安全等級: 中                                             │
├─────────────────────────────────────────────────────────────┤
│ VLAN 40: 訪客網路 (Guest)                                  │
│ - 範圍: 192.168.40.0/24                                   │
│ - 設備: 訪客設備、IoT 設備                                 │
│ - 安全等級: 低                                             │
└─────────────────────────────────────────────────────────────┘
```

##### 網路管理員如何使用 VLAN

###### 1. VLAN 規劃策略

**業務導向規劃**
```
根據業務需求劃分 VLAN:
- 部門 VLAN: 按組織架構劃分
- 功能 VLAN: 按功能需求劃分
- 安全 VLAN: 按安全等級劃分
- 服務 VLAN: 按服務類型劃分
```

**網路效能規劃**
```
VLAN 大小考量:
- 小型 VLAN (≤ 100 設備): 高效能，低延遲
- 中型 VLAN (100-500 設備): 平衡效能與管理
- 大型 VLAN (> 500 設備): 需要進一步分段
```

###### 2. VLAN 配置步驟

**步驟 1: VLAN 設計**
```
1. 識別業務需求
2. 分析網路流量模式
3. 確定 VLAN 數量與範圍
4. 規劃 VLAN 間路由策略
5. 設計安全策略
```

**步驟 2: 交換機配置**
```
Cisco 交換機 VLAN 配置範例:
Switch# configure terminal
Switch(config)# vlan 10
Switch(config-vlan)# name Management
Switch(config-vlan)# exit

Switch(config)# interface fastethernet 0/1
Switch(config-if)# switchport mode access
Switch(config-if)# switchport access vlan 10
Switch(config-if)# exit
```

**步驟 3: 路由配置**
```
VLAN 間路由配置:
Router# configure terminal
Router(config)# interface vlan 10
Router(config-if)# ip address 192.168.10.1 255.255.255.0
Router(config-if)# exit

Router(config)# interface vlan 20
Router(config-if)# ip address 192.168.20.1 255.255.255.0
Router(config-if)# exit
```

###### 3. VLAN 間通訊控制

**ACL (Access Control List) 配置**
```
允許管理網路存取生產網路:
Router(config)# access-list 100 permit ip 192.168.10.0 0.0.0.255 192.168.20.0 0.0.0.255
Router(config)# interface vlan 10
Router(config-if)# ip access-group 100 out
```

**防火牆規則**
```
VLAN 間防火牆配置:
- VLAN 10 → VLAN 20: 允許特定服務
- VLAN 20 → VLAN 10: 拒絕所有流量
- VLAN 30 → VLAN 40: 允許 HTTP/HTTPS
- VLAN 40 → VLAN 30: 拒絕所有流量
```

##### 不同網路串接成區域網路

###### 1. VLAN Trunk 技術

**Trunk 概念**
```
Trunk 是承載多個 VLAN 的鏈路，使用 802.1Q 標籤區分不同 VLAN。

Trunk 配置範例:
Switch(config)# interface gigabitethernet 0/1
Switch(config-if)# switchport mode trunk
Switch(config-if)# switchport trunk allowed vlan 10,20,30,40
Switch(config-if)# switchport trunk native vlan 1
```

**Trunk 協議**
```
ISL (Inter-Switch Link):
- Cisco 專有協議
- 30 字節標籤
- 支援 1000 個 VLAN

802.1Q:
- IEEE 標準協議
- 4 字節標籤
- 支援 4094 個 VLAN
- 廣泛支援
```

###### 2. 多站點 VLAN 連接

**Layer 2 延伸**
```
使用 Metro Ethernet 或 MPLS 延伸 VLAN:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 總部            │  │ 骨幹網路        │  │ 分支            │
│ VLAN 10,20,30   │──│ MPLS/ Metro-E   │──│ VLAN 10,20,30   │
│ 192.168.x.0/24  │  │                 │  │ 192.168.x.0/24  │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

**Layer 3 連接**
```
使用路由連接不同站點:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 總部            │  │ 骨幹網路        │  │ 分支            │
│ 10.1.x.0/24     │──│ IP/MPLS         │──│ 10.2.x.0/24     │
│ VLAN 10,20,30   │  │                 │  │ VLAN 10,20,30   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

###### 3. 虛擬化環境 VLAN

**VMware VLAN 配置**
```
vSphere 虛擬交換機 VLAN 配置:
1. 建立虛擬交換機
2. 配置 VLAN ID
3. 分配虛擬機器到 VLAN
4. 配置上行鏈路到實體交換機
```

**容器網路 VLAN**
```
Docker/Kubernetes VLAN 配置:
- 使用 CNI 插件支援 VLAN
- 配置網路策略
- 實現容器間隔離
```

##### VLAN 監控與管理

###### 1. VLAN 監控工具

**SNMP 監控**
```
VLAN 統計監控:
- VLAN 流量統計
- 廣播風暴檢測
- 錯誤率監控
- 效能指標收集
```

**網路分析工具**
```
Wireshark VLAN 分析:
- 過濾特定 VLAN 流量
- 分析 VLAN 標籤
- 監控 VLAN 間通訊
- 故障排除
```

###### 2. VLAN 管理最佳實踐

**文檔管理**
```
VLAN 文檔應包含:
- VLAN ID 與名稱對應
- IP 地址範圍
- 設備清單
- 安全策略
- 變更記錄
```

**變更管理**
```
VLAN 變更流程:
1. 變更申請與審核
2. 影響分析
3. 備份配置
4. 實施變更
5. 驗證測試
6. 文檔更新
```

##### VLAN 故障排除

###### 1. 常見 VLAN 問題

**VLAN 間無法通訊**
```
症狀: 不同 VLAN 的設備無法互相通訊
原因:
- 路由配置錯誤
- ACL 阻擋
- 防火牆規則
- VLAN 配置錯誤

解決方案:
1. 檢查路由表
2. 驗證 ACL 配置
3. 檢查防火牆規則
4. 確認 VLAN 配置
```

**Trunk 鏈路問題**
```
症狀: VLAN 無法跨越交換機
原因:
- Trunk 配置錯誤
- VLAN 未允許通過
- 標籤協議不匹配

解決方案:
1. 檢查 Trunk 配置
2. 確認允許的 VLAN
3. 驗證標籤協議
4. 檢查物理連接
```

###### 2. VLAN 診斷命令

**Cisco 診斷命令**
```
# 檢查 VLAN 配置
show vlan brief

# 檢查 Trunk 配置
show interfaces trunk

# 檢查 VLAN 間路由
show ip route

# 檢查 ACL 配置
show access-lists
```

**故障排除流程**
```
1. 確認 VLAN 配置
2. 檢查 Trunk 狀態
3. 驗證路由配置
4. 測試連通性
5. 檢查安全策略
6. 分析流量模式
```

#### IPv6 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 版本 │ 流量類別 │ 流標籤                                   │
├─────────────────────────────────────────────────────────────┤
│ 載荷長度 │ 下一個標頭 │ 跳躍限制                           │
├─────────────────────────────────────────────────────────────┤
│ 來源地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 目標地址 (128位元)                                          │
├─────────────────────────────────────────────────────────────┤
│ 擴展標頭 (可選)                                             │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

### IPv4 與 IPv6 的轉換

#### 雙棧技術 (Dual Stack)
同時支援 IPv4 和 IPv6 協議：
```
應用層
    ↓
傳輸層 (TCP/UDP)
    ↓
網路層 (IPv4 + IPv6)
    ↓
資料鏈路層
```

#### 隧道技術 (Tunneling)
- **6to4**: IPv6 封包封裝在 IPv4 中
- **Teredo**: 通過 UDP 傳輸 IPv6
- **6in4**: 手動配置的 IPv6-in-IPv4 隧道

#### 轉換技術 (Translation)
- **NAT64**: IPv6 客戶端訪問 IPv4 服務器
- **DNS64**: DNS 查詢轉換
- **SIIT**: 無狀態 IP/ICMP 轉換

### Local IP vs Global IP

#### Local IP (私有 IP)
- **範圍**:
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- **用途**: 內部網路通訊
- **特點**: 不可路由到網際網路

#### Global IP (全域 IP)
- **範圍**: 除私有 IP 外的所有地址
- **用途**: 網際網路通訊
- **特點**: 全域唯一，可路由

#### NAT (Network Address Translation)
```
內部網路: 192.168.1.100 → NAT 路由器 → 網際網路: 203.0.113.1
```

## 傳輸層協議

### TCP (Transmission Control Protocol)

#### TCP 特色
- **可靠傳輸**: 確認機制、重傳機制
- **有序傳輸**: 序列號確保資料順序
- **流量控制**: 滑動視窗機制
- **擁塞控制**: 動態調整傳輸速率
- **全雙工**: 同時雙向通訊

#### TCP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 序列號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 確認號                                                       │
├─────────────────────────────────────────────────────────────┤
│ 資料偏移 │ 保留 │ 標誌 │ 視窗大小                           │
├─────────────────────────────────────────────────────────────┤
│ 校驗和 │ 緊急指標                                           │
├─────────────────────────────────────────────────────────────┤
│ 選項 (可選)                                                 │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### TCP 連接狀態機
```
CLOSED → LISTEN → SYN_SENT → ESTABLISHED → CLOSE_WAIT → CLOSED
    ↓         ↓         ↓
SYN_RCVD → ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED
```

#### TCP 應用場景
- **檔案傳輸**: FTP、SFTP
- **網頁瀏覽**: HTTP、HTTPS
- **電子郵件**: SMTP、POP3、IMAP
- **遠端登入**: SSH、Telnet
- **資料庫**: MySQL、PostgreSQL

### UDP (User Datagram Protocol)

#### UDP 特色
- **無連接**: 無需建立連接
- **不可靠**: 無確認機制
- **無序**: 不保證資料順序
- **輕量級**: 標頭開銷小
- **快速**: 低延遲傳輸

#### UDP 封包結構
```
┌─────────────────────────────────────────────────────────────┐
│ 來源埠 │ 目標埠                                             │
├─────────────────────────────────────────────────────────────┤
│ 長度 │ 校驗和                                               │
├─────────────────────────────────────────────────────────────┤
│ 資料                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### UDP 應用場景
- **即時通訊**: VoIP、視訊會議
- **遊戲**: 線上遊戲
- **串流媒體**: 音訊、視訊串流
- **DNS**: 網域名稱解析
- **DHCP**: 動態主機配置

## 應用層協議

### MQTT (Message Queuing Telemetry Transport)

#### MQTT 特色
- **輕量級**: 最小化網路頻寬使用
- **QoS 等級**: 三種服務品質等級
- **發布/訂閱模式**: 鬆散耦合的通訊
- **保留訊息**: 新訂閱者可接收最後訊息
- **遺囑訊息**: 異常斷線時發送通知

#### MQTT 封包類型
| 類型 | 值 | 用途 |
|------|----|------|
| CONNECT | 1 | 客戶端連接 |
| CONNACK | 2 | 連接確認 |
| PUBLISH | 3 | 發布訊息 |
| PUBACK | 4 | 發布確認 |
| SUBSCRIBE | 8 | 訂閱主題 |
| SUBACK | 9 | 訂閱確認 |
| DISCONNECT | 14 | 斷開連接 |

#### MQTT QoS 等級
- **QoS 0**: 最多一次傳遞
- **QoS 1**: 至少一次傳遞
- **QoS 2**: 恰好一次傳遞

#### MQTT 應用場景
- **物聯網**: 感測器資料收集
- **智慧家居**: 設備控制
- **工業監控**: 設備狀態監控
- **車聯網**: 車輛資料傳輸

### WebSocket

#### WebSocket 特色
- **全雙工通訊**: 同時雙向資料傳輸
- **持久連接**: 單一連接支援多次通訊
- **低延遲**: 減少連接建立開銷
- **瀏覽器支援**: 原生 JavaScript API
- **協議升級**: 從 HTTP 升級到 WebSocket

#### WebSocket 握手過程
```
客戶端 → HTTP GET (Upgrade: websocket)
    ↓
服務器 → HTTP 101 Switching Protocols
    ↓
WebSocket 連接建立
```

#### WebSocket 幀格式
```
┌─────────────────────────────────────────────────────────────┐
│ FIN │ RSV1 │ RSV2 │ RSV3 │ 操作碼 │ MASK │ 載荷長度         │
├─────────────────────────────────────────────────────────────┤
│ 擴展載荷長度 (可選)                                         │
├─────────────────────────────────────────────────────────────┤
│ 遮罩金鑰 (如果 MASK=1)                                      │
├─────────────────────────────────────────────────────────────┤
│ 載荷資料                                                   │
└─────────────────────────────────────────────────────────────┘
```

#### WebSocket 應用場景
- **即時聊天**: 即時通訊應用
- **線上遊戲**: 多人遊戲
- **協作工具**: 文件協作
- **金融交易**: 即時報價
- **監控儀表板**: 即時資料顯示

### QUIC (Quick UDP Internet Connections)

#### QUIC 特色
- **基於 UDP**: 避免 TCP 的隊頭阻塞
- **內建加密**: TLS 1.3 整合
- **多路復用**: 單一連接多個資料流
- **連接遷移**: 網路切換時保持連接
- **前向糾錯**: 減少重傳需求

#### QUIC vs TCP
| 特性 | QUIC | TCP |
|------|------|-----|
| 傳輸層 | UDP | TCP |
| 加密 | 內建 | 外掛 |
| 多路復用 | 原生支援 | 需要 HTTP/2 |
| 連接遷移 | 支援 | 不支援 |
| 隊頭阻塞 | 無 | 有 |

#### QUIC 應用場景
- **HTTP/3**: 下一代 HTTP 協議
- **串流媒體**: 低延遲視訊串流
- **遊戲**: 即時多人遊戲
- **移動應用**: 網路切換優化

## 安全協議

### TLS (Transport Layer Security)

#### TLS 版本演進
- **TLS 1.0**: 1999年發布
- **TLS 1.1**: 2006年發布
- **TLS 1.2**: 2008年發布
- **TLS 1.3**: 2018年發布（最新）

#### TLS 1.3 特色
- **零往返時間**: 0-RTT 連接恢復
- **強制加密**: 所有連接都加密
- **前向安全性**: 完美前向保密
- **簡化握手**: 減少握手步驟
- **移除弱加密**: 淘汰不安全的加密套件

#### TLS 握手過程
```
客戶端 → ClientHello (支援的加密套件)
    ↓
服務器 → ServerHello (選擇的加密套件)
    ↓
服務器 → Certificate (數位憑證)
    ↓
服務器 → ServerKeyExchange (金鑰交換)
    ↓
客戶端 → ClientKeyExchange (金鑰交換)
    ↓
雙方 → ChangeCipherSpec (切換到加密模式)
    ↓
雙方 → Finished (握手完成)
```

#### TLS 加密套件
```
TLS_AES_256_GCM_SHA384
├── TLS: 協議名稱
├── AES_256: 對稱加密算法
├── GCM: 操作模式
└── SHA384: 雜湊函數
```

### HTTPS (HTTP Secure)

#### HTTPS 特色
- **端到端加密**: 資料在傳輸過程中加密
- **身份驗證**: 防止中間人攻擊
- **資料完整性**: 防止資料篡改
- **SEO 優勢**: 搜尋引擎偏好 HTTPS
- **瀏覽器信任**: 現代瀏覽器要求 HTTPS

#### HTTPS 工作流程
```
1. DNS 解析 → 獲取服務器 IP
2. TCP 連接 → 建立傳輸層連接
3. TLS 握手 → 建立安全通道
4. HTTP 請求/回應 → 在安全通道中傳輸
```

#### 憑證類型
- **DV (Domain Validation)**: 網域驗證
- **OV (Organization Validation)**: 組織驗證
- **EV (Extended Validation)**: 擴展驗證
- **Wildcard**: 萬用字元憑證
- **SAN (Subject Alternative Name)**: 多網域憑證

## Quectel 模組實作範例

### MAC 層配置與支援

#### Quectel 模組 MAC 層支援

Quectel 模組在 MAC 層提供了完整的蜂窩網路協議支援，包括：

##### 1. 多模網路支援
```at
// 檢查模組支援的網路模式
AT+QCFG="nwscanmode"

// 設定網路掃描模式
AT+QCFG="nwscanmode",3,1,3,1

// 檢查當前網路模式
AT+QNWINFO
```

##### 2. 網路註冊與 MAC 層連接
```at
// 檢查網路註冊狀態
AT+CREG?

// 檢查 GPRS 服務狀態
AT+CGATT?

// 檢查網路運營商
AT+COPS?

// 檢查訊號品質 (影響 MAC 層傳輸)
AT+CSQ
```

##### 3. MAC 層參數配置

###### 傳輸功率控制
```at
// 檢查發射功率等級
AT+QPOWD?

// 設定發射功率等級 (0-5)
AT+QPOWD=3
```

###### 接收靈敏度配置
```at
// 檢查接收靈敏度
AT+QRSRP?

// 設定接收靈敏度閾值
AT+QRSRP=1,-120,-110
```

###### 頻道配置
```at
// 檢查頻道配置
AT+QCFG="band"

// 設定頻段 (例如: LTE Band 1,3,5,8)
AT+QCFG="band",0x80,0x800800,0x800800,0x0
```

##### 4. PPP 連接配置

###### PPP 基本配置
```at
// 配置 PPP 連接參數
AT+CGDCONT=1,"IP","internet"

// 啟動 PPP 連接
AT+CGACT=1,1

// 檢查 PPP 連接狀態
AT+CGACT?
```

###### PPP 認證配置
```at
// 配置 PAP 認證
AT+CGDCONT=1,"IP","internet","",0,0,"PAP"

// 配置 CHAP 認證
AT+CGDCONT=1,"IP","internet","",0,0,"CHAP"

// 設定認證資訊
AT+CGAUTH=1,1,"username","password"
```

##### 5. MAC 層效能監控

###### 傳輸統計
```at
// 檢查資料傳輸統計
AT+QISTATS

// 檢查網路連接統計
AT+QNWINFO
```

### VLAN 配置與支援

#### Quectel 模組 VLAN 支援

Quectel 模組支援 VLAN 配置，允許在單一實體連接上建立多個邏輯網路。

##### 1. VLAN 基本配置
```at
// 檢查模組 VLAN 支援
AT+QVLAN?

// 配置 VLAN ID
AT+QVLAN=1,10

// 配置多個 VLAN
AT+QVLAN=1,10
AT+QVLAN=2,20
AT+QVLAN=3,30

// 檢查 VLAN 配置狀態
AT+QVLAN?
```

##### 2. VLAN 標籤配置
```at
// 配置 802.1Q VLAN 標籤
AT+QVLAN=1,10,1  // VLAN ID 10, 啟用標籤

// 配置 VLAN 優先級
AT+QVLAN=1,10,1,5  // VLAN ID 10, 標籤啟用, 優先級 5

// 配置原生 VLAN
AT+QVLAN=1,1,0  // 原生 VLAN 1, 無標籤

// 檢查 VLAN 標籤狀態
AT+QVLAN?
```

##### 3. VLAN 間路由配置
```at
// 配置 VLAN 間路由
AT+QROUTE=1,"192.168.10.0","255.255.255.0","192.168.1.1",10

// 配置 VLAN 預設路由
AT+QROUTE=1,"0.0.0.0","0.0.0.0","192.168.1.1",10

// 檢查 VLAN 路由表
AT+QROUTE?

// 刪除 VLAN 路由
AT+QROUTE=0,"192.168.10.0","255.255.255.0",10
```

##### 4. VLAN 安全配置
```at
// 配置 VLAN ACL
AT+QACL=1,10,"permit","192.168.10.0","255.255.255.0","192.168.20.0","255.255.255.0"

// 配置 VLAN 防火牆規則
AT+QFIREWALL=1,10,"allow","tcp","80,443"

// 檢查 VLAN 安全配置
AT+QACL?
AT+QFIREWALL?
```

##### 5. VLAN 監控與診斷
```at
// 檢查 VLAN 統計
AT+QVLANSTAT=10

// 檢查 VLAN 流量
AT+QVLANFLOW=10

// 檢查 VLAN 錯誤
AT+QVLANERR=10

// VLAN 連通性測試
AT+QPING="192.168.10.100",10
```

###### 錯誤率監控
```at
// 檢查 HARQ 重傳統計
AT+QHARQ?

// 檢查 CRC 錯誤統計
AT+QCRC?
```

##### 6. 進階 MAC 層功能

###### 載波聚合 (Carrier Aggregation)
```at
// 檢查載波聚合支援
AT+QCAINFO?

// 配置載波聚合
AT+QCFG="ca",1
```

###### MIMO 配置
```at
// 檢查 MIMO 配置
AT+QMIMO?

// 設定 MIMO 模式
AT+QMIMO=1,2  // 2x2 MIMO
```

###### 波束成形 (5G)
```at
// 檢查波束成形狀態
AT+QBEAM?

// 配置波束成形
AT+QBEAM=1
```

##### 7. MAC 層除錯指令

###### 詳細狀態檢查
```at
// 檢查詳細網路狀態
AT+QNWINFO

// 檢查無線資源狀態
AT+QNWINFO=1

// 檢查 MAC 層統計
AT+QMACINFO
```

###### 連接品質監控
```at
// 檢查 RSRP (參考信號接收功率)
AT+QRSRP

// 檢查 RSRQ (參考信號接收品質)
AT+QRSRQ

// 檢查 SINR (信號干擾噪聲比)
AT+QSINR
```

##### 8. MAC 層優化配置

###### 低延遲配置
```at
// 配置低延遲模式
AT+QCFG="latency",1

// 設定 QoS 等級
AT+QCFG="qos",1,1
```

###### 省電模式配置
```at
// 配置 PSM (Power Saving Mode)
AT+CPSMS=1,"00000001","00000001"

// 配置 eDRX (Extended Discontinuous Reception)
AT+CEDRXS=1,5,"0001"
```

###### 傳輸優化
```at
// 配置 TCP 優化
AT+QCFG="tcp",1,1

// 配置 UDP 優化
AT+QCFG="udp",1,1
```

##### 9. IP 配置與支援

#### IPv4 子網路配置

##### IPv4 地址配置
```at
// 檢查當前 IP 地址
AT+CGPADDR=1

// 配置靜態 IP 地址
AT+CGDCONT=1,"IP","internet","192.168.1.100"

// 配置子網路遮罩
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.255.0"

// 配置預設閘道
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.255.0","192.168.1.1"

// 配置 DNS 伺服器
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.255.0","192.168.1.1","8.8.8.8","8.8.4.4"
```

##### IPv4 子網路管理
```at
// 檢查網路配置
AT+QICSGP=1,1,"internet","192.168.1.100","255.255.255.0","192.168.1.1",1

// 配置多個子網路
AT+QICSGP=1,1,"internet","192.168.1.100","255.255.255.0","192.168.1.1",1
AT+QICSGP=2,1,"internet","192.168.2.100","255.255.255.0","192.168.2.1",1

// 檢查子網路連接狀態
AT+QICSGP?
```

##### IPv4 路由配置
```at
// 配置靜態路由
AT+QROUTE=1,"192.168.10.0","255.255.255.0","192.168.1.254"

// 檢查路由表
AT+QROUTE?

// 刪除路由
AT+QROUTE=0,"192.168.10.0","255.255.255.0"
```

#### IPv6 配置與支援

##### IPv6 地址配置
```at
// 檢查 IPv6 地址
AT+CGPADDR=1

// 配置 IPv6 前綴
AT+CGDCONT=1,"IPV6","internet","","","","","","2001:db8:1234::/64"

// 配置 IPv6 全域地址
AT+CGDCONT=1,"IPV6","internet","2001:db8:1234:5678::100/64"

// 配置 IPv6 鏈路本地地址
AT+CGDCONT=1,"IPV6","internet","fe80::1a2b:3c4d:5e6f:7890/64"
```

##### IPv6 子網路配置
```at
// 配置 IPv6 子網路前綴
AT+QICSGP=1,1,"internet","","","","","","2001:db8:1234::/64"

// 配置多個 IPv6 子網路
AT+QICSGP=1,1,"internet","","","","","","2001:db8:1234:0000::/64"
AT+QICSGP=2,1,"internet","","","","","","2001:db8:1234:0001::/64"

// 檢查 IPv6 子網路狀態
AT+QICSGP?
```

##### IPv6 自動配置
```at
// 啟用 SLAAC (無狀態地址自動配置)
AT+QCFG="ipv6",1

// 配置 DHCPv6
AT+QCFG="dhcpv6",1

// 檢查 IPv6 自動配置狀態
AT+QCFG="ipv6"?
```

##### IPv6 路由配置
```at
// 配置 IPv6 靜態路由
AT+QROUTE=1,"2001:db8:1234:0000::/64","2001:db8:1234::1"

// 檢查 IPv6 路由表
AT+QROUTE?

// 配置 IPv6 預設路由
AT+QROUTE=1,"::/0","2001:db8:1234::1"
```

#### 雙棧 (Dual Stack) 配置

##### IPv4/IPv6 同時支援
```at
// 啟用雙棧模式
AT+QCFG="dualstack",1

// 配置雙棧連接
AT+CGDCONT=1,"IPV4V6","internet","192.168.1.100","255.255.255.0","192.168.1.1","","","2001:db8:1234::/64"

// 檢查雙棧狀態
AT+QCFG="dualstack"?
```

##### 協議優先級配置
```at
// 設定 IPv6 優先
AT+QCFG="ipv6pref",1

// 設定 IPv4 優先
AT+QCFG="ipv6pref",0

// 檢查協議優先級
AT+QCFG="ipv6pref"?
```

#### IP 層效能監控

##### 網路統計
```at
// 檢查 IP 層統計
AT+QISTATS

// 檢查封包統計
AT+QPACKET?

// 檢查錯誤統計
AT+QERROR?
```

##### 連接品質監控
```at
// 檢查網路延遲
AT+QPING="8.8.8.8"

// 檢查 IPv6 延遲
AT+QPING="2001:4860:4860::8888"

// 檢查路由追蹤
AT+QTRACE="8.8.8.8"
```

##### 10. PDCP 層配置

###### PDCP 標頭壓縮配置
```at
// 檢查 PDCP 壓縮狀態
AT+QPDCP?

// 啟用 ROHC 壓縮
AT+QPDCP=1

// 配置壓縮模式 (0=非壓縮, 1=靜態壓縮, 2=動態壓縮)
AT+QPDCP=1,2

// 配置壓縮協議 (1=IP, 2=IP/UDP, 3=IP/UDP/RTP)
AT+QPDCP=1,2,3
```

###### PDCP 加密配置
```at
// 檢查加密狀態
AT+QENCRYPT?

// 啟用 PDCP 加密
AT+QENCRYPT=1

// 配置加密算法 (1=AES, 2=SNOW3G, 3=ZUC)
AT+QENCRYPT=1,1

// 配置完整性保護
AT+QENCRYPT=1,1,1
```

###### PDCP 序列號配置
```at
// 檢查序列號配置
AT+QPDCPSN?

// 設定序列號大小 (12位元或18位元)
AT+QPDCPSN=12

// 配置重排序計時器
AT+QPDCPSN=12,1000
```

##### 10. RLC 層配置

###### RLC 模式配置
```at
// 檢查 RLC 模式
AT+QRLC?

// 設定 RLC 模式 (1=TM, 2=UM, 3=AM)
AT+QRLC=3

// 配置 UM 模式參數
AT+QRLC=2,1024,1000

// 配置 AM 模式參數
AT+QRLC=3,2048,2000,500
```

###### RLC 視窗大小配置
```at
// 檢查視窗大小
AT+QRLCWIN?

// 設定發送視窗大小
AT+QRLCWIN=2048

// 設定接收視窗大小
AT+QRLCWIN=2048,2048

// 配置重傳計時器
AT+QRLCWIN=2048,2048,500
```

###### RLC 分段配置
```at
// 檢查分段配置
AT+QRLCSEG?

// 設定最大分段大小
AT+QRLCSEG=1500

// 設定最小分段大小
AT+QRLCSEG=1500,100

// 啟用動態分段
AT+QRLCSEG=1500,100,1
```

##### 11. PDCP/RLC 效能監控

###### PDCP 統計
```at
// 檢查 PDCP 統計資訊
AT+QPDCPSTAT?

// 檢查壓縮統計
AT+QPDCPSTAT=1

// 檢查加密統計
AT+QPDCPSTAT=2
```

###### RLC 統計
```at
// 檢查 RLC 統計資訊
AT+QRLCSTAT?

// 檢查重傳統計
AT+QRLCSTAT=1

// 檢查分段統計
AT+QRLCSTAT=2
```

##### 12. PDCP/RLC 除錯指令

###### PDCP 除錯
```at
// 啟用 PDCP 除錯模式
AT+QPDCPDEBUG=1

// 檢查 PDCP 狀態
AT+QPDCPSTATUS

// 檢查壓縮效率
AT+QPDCPEFF
```

###### RLC 除錯
```at
// 啟用 RLC 除錯模式
AT+QRLCDEBUG=1

// 檢查 RLC 狀態
AT+QRLCSTATUS

// 檢查視窗狀態
AT+QRLCWINDOW
```

### 基本網路配置

#### AT 指令配置網路
```at
// 檢查模組狀態
AT+CPIN?

// 註冊網路
AT+CREG?

// 配置 APN
AT+CGDCONT=1,"IP","internet"

// 連接網路
AT+CGACT=1,1

// 檢查 IP 地址
AT+CGPADDR=1
```

#### TCP 連接範例
```at
// 建立 TCP 連接
AT+QIOPEN=1,0,"TCP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

#### UDP 連接範例
```at
// 建立 UDP 連接
AT+QIOPEN=1,1,"UDP","192.168.1.100",8080,0,0

// 發送資料
AT+QISEND=1,5
Hello

// 接收資料
AT+QIRD=1,100

// 關閉連接
AT+QICLOSE=1
```

### MQTT 實作範例

#### MQTT 連接
```at
// 配置 MQTT 參數
AT+QMTCFG="version",0,4

// 連接到 MQTT 代理
AT+QMTOPEN=0,"mqtt.example.com",1883

// 登入 MQTT
AT+QMTCONN=0,"client_id"

// 訂閱主題
AT+QMTSUB=0,1,"topic/test",1

// 發布訊息
AT+QMTPUB=0,0,0,0,"topic/test"
Hello MQTT

// 斷開連接
AT+QMTDISC=0
```

### HTTPS 實作範例

#### HTTPS 請求
```at
// 配置 HTTPS 參數
AT+QSSLCFG="sslversion",0,4

// 建立 HTTPS 連接
AT+QHTTPGET="https://api.example.com/data"

// 讀取回應
AT+QHTTPREAD

// 關閉連接
AT+QHTTPTERM
```

### WebSocket 實作範例

#### WebSocket 連接
```at
// 建立 WebSocket 連接
AT+QWSOPEN=0,"ws://echo.websocket.org"

// 發送訊息
AT+QWSEND=0,5
Hello

// 接收訊息
AT+QWSRECV=0,100

// 關閉連接
AT+QWSCLOSE=0
```

## 常見問題與故障排除

### MAC 層與網路連接問題

#### MAC 層連接問題

##### 無法註冊網路
**症狀**: `+CREG: 0,2` 或 `+CREG: 0,3`
**MAC 層原因**:
- MAC 層資源分配失敗
- 無線頻道擁塞
- 基地台拒絕連接
**解決方案**:
1. 檢查 SIM 卡是否正確插入
2. 確認 SIM 卡有足夠餘額
3. 檢查訊號強度: `AT+CSQ`
4. 重新啟動模組: `AT+CFUN=1,1`
5. 檢查 MAC 層狀態: `AT+QMACINFO`
6. 重新配置頻段: `AT+QCFG="band"`

##### MAC 層傳輸錯誤
**症狀**: 資料傳輸不穩定或錯誤率高
**MAC 層原因**:
- HARQ 重傳次數過多
- MAC 層緩衝區溢出
- 無線資源不足
**解決方案**:
1. 檢查 HARQ 統計: `AT+QHARQ?`
2. 檢查 CRC 錯誤: `AT+QCRC?`
3. 調整傳輸功率: `AT+QPOWD`
4. 檢查 MAC 層統計: `AT+QISTATS`
5. 重新配置 QoS 參數

##### PPP 連接失敗
**症狀**: `+CGACT: 1,0` 返回錯誤
**MAC 層原因**:
- PPP 認證失敗
- MAC 層資源不足
- 網路擁塞
**解決方案**:
1. 檢查 PPP 配置: `AT+CGDCONT?`
2. 重新配置認證: `AT+CGAUTH`
3. 檢查 MAC 層狀態: `AT+QMACINFO`
4. 重新啟動 PDP 上下文

##### PDCP 層問題

###### PDCP 壓縮失敗
**症狀**: 資料傳輸效率低，頻寬使用率高
**PDCP 層原因**:
- 標頭壓縮配置錯誤
- 壓縮算法不匹配
- 序列號溢出
**解決方案**:
1. 檢查 PDCP 壓縮狀態: `AT+QPDCP?`
2. 重新配置壓縮模式: `AT+QPDCP=1,2`
3. 檢查序列號配置: `AT+QPDCPSN?`
4. 重置 PDCP 層: `AT+QPDCPRESET`

###### PDCP 加密錯誤
**症狀**: 資料傳輸失敗或安全警告
**PDCP 層原因**:
- 加密算法不匹配
- 金鑰配置錯誤
- 完整性保護失敗
**解決方案**:
1. 檢查加密配置: `AT+QENCRYPT?`
2. 重新配置加密算法: `AT+QENCRYPT=1,1`
3. 檢查金鑰配置
4. 重新建立安全上下文

##### RLC 層問題

###### RLC 重傳過多
**症狀**: 傳輸延遲高，吞吐量低
**RLC 層原因**:
- 視窗大小配置不當
- 重傳計時器過短
- 網路品質差
**解決方案**:
1. 檢查 RLC 統計: `AT+QRLCSTAT?`
2. 調整視窗大小: `AT+QRLCWIN=4096`
3. 增加重傳計時器: `AT+QRLCWIN=4096,4096,1000`
4. 檢查網路品質: `AT+CSQ`

###### RLC 分段錯誤
**症狀**: 資料丟失或重複
**RLC 層原因**:
- 分段大小配置錯誤
- 序列號管理問題
- 緩衝區溢出
**解決方案**:
1. 檢查分段配置: `AT+QRLCSEG?`
2. 調整分段大小: `AT+QRLCSEG=1500`
3. 檢查 RLC 狀態: `AT+QRLCSTATUS`
4. 重新配置 RLC 模式: `AT+QRLC=3`

#### 網路連接問題
**症狀**: `+CREG: 0,2` 或 `+CREG: 0,3`
**解決方案**:
1. 檢查 SIM 卡是否正確插入
2. 確認 SIM 卡有足夠餘額
3. 檢查訊號強度: `AT+CSQ`
4. 重新啟動模組: `AT+CFUN=1,1`

#### 無法獲取 IP 地址
**症狀**: `+CGPADDR: 1` 返回空值
**解決方案**:
1. 檢查 APN 配置
2. 確認網路註冊狀態
3. 重新啟動 PDP 上下文: `AT+CGACT=0,1` 然後 `AT+CGACT=1,1`

#### IPv4 子網路配置問題

##### 子網路遮罩配置錯誤
**症狀**: 無法與同一子網路內的其他設備通訊
**原因**:
- 子網路遮罩設定錯誤
- 網路地址計算錯誤
- 路由配置不當
**解決方案**:
1. 檢查子網路遮罩配置: `AT+CGDCONT?`
2. 重新配置正確的子網路遮罩: `AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.255.0"`
3. 驗證網路地址計算
4. 檢查路由表: `AT+QROUTE?`

##### 廣播域問題
**症狀**: 廣播封包無法到達目標設備
**原因**:
- 廣播地址配置錯誤
- 路由器阻擋廣播封包
- 子網路劃分不當
**解決方案**:
1. 檢查廣播地址配置
2. 確認路由器廣播設定
3. 重新規劃子網路劃分
4. 使用單播替代廣播

##### 靜態 IP 衝突
**症狀**: 網路連接不穩定或無法連接
**原因**:
- IP 地址已被其他設備使用
- DHCP 與靜態 IP 衝突
- 子網路範圍重疊
**解決方案**:
1. 檢查 IP 地址衝突: `AT+QPING="192.168.1.100"`
2. 重新分配靜態 IP 地址
3. 配置 DHCP 保留地址
4. 檢查子網路範圍

#### IPv6 配置問題

##### IPv6 地址自動配置失敗
**症狀**: 無法獲得 IPv6 地址
**原因**:
- SLAAC 配置錯誤
- 路由器公告 (RA) 未收到
- 前綴長度配置錯誤
**解決方案**:
1. 檢查 IPv6 自動配置: `AT+QCFG="ipv6"?`
2. 重新配置 SLAAC: `AT+QCFG="ipv6",1`
3. 檢查路由器公告
4. 手動配置 IPv6 地址

##### IPv6 子網路前綴錯誤
**症狀**: IPv6 通訊失敗
**原因**:
- 前綴長度設定錯誤
- 子網路前綴不匹配
- 路由配置錯誤
**解決方案**:
1. 檢查 IPv6 前綴配置: `AT+CGDCONT?`
2. 重新配置正確的前綴: `AT+CGDCONT=1,"IPV6","internet","","","","","","2001:db8:1234::/64"`
3. 驗證前綴長度
4. 檢查 IPv6 路由: `AT+QROUTE?`

##### 雙棧模式問題
**症狀**: IPv4 或 IPv6 其中一種協議無法工作
**原因**:
- 雙棧配置錯誤
- 協議優先級設定不當
- 網路不支援雙棧
**解決方案**:
1. 檢查雙棧配置: `AT+QCFG="dualstack"?`
2. 重新配置雙棧: `AT+QCFG="dualstack",1`
3. 調整協議優先級: `AT+QCFG="ipv6pref",1`
4. 分別測試 IPv4 和 IPv6 連接

##### IPv6 鏈路本地地址問題
**症狀**: 無法與同一鏈路上的設備通訊
**原因**:
- 鏈路本地地址配置錯誤
- 介面識別碼衝突
- 鄰居發現失敗
**解決方案**:
1. 檢查鏈路本地地址: `AT+CGPADDR=1`
2. 重新配置介面識別碼
3. 檢查鄰居發現狀態
4. 使用全域地址替代

#### VLAN 配置問題

##### VLAN 間無法通訊
**症狀**: 不同 VLAN 的設備無法互相通訊
**原因**:
- VLAN 配置錯誤
- 路由配置不當
- ACL 阻擋
- 防火牆規則限制
**解決方案**:
1. 檢查 VLAN 配置: `AT+QVLAN?`
2. 驗證路由配置: `AT+QROUTE?`
3. 檢查 ACL 設定: `AT+QACL?`
4. 確認防火牆規則: `AT+QFIREWALL?`

##### VLAN 標籤問題
**症狀**: VLAN 標籤無法正確處理
**原因**:
- 802.1Q 標籤配置錯誤
- 優先級設定不當
- 原生 VLAN 配置錯誤
**解決方案**:
1. 檢查 VLAN 標籤配置: `AT+QVLAN?`
2. 重新配置標籤: `AT+QVLAN=1,10,1`
3. 調整優先級設定
4. 確認原生 VLAN 配置

##### VLAN 安全策略問題
**症狀**: VLAN 間通訊被意外阻擋
**原因**:
- ACL 規則過於嚴格
- 防火牆配置錯誤
- 安全策略衝突
**解決方案**:
1. 檢查 ACL 配置: `AT+QACL?`
2. 驗證防火牆規則: `AT+QFIREWALL?`
3. 調整安全策略
4. 測試 VLAN 間連通性: `AT+QPING="192.168.10.100",10`

### 協議層問題

#### TCP 連接失敗
**症狀**: `+QIOPEN: 1,0` 返回錯誤
**解決方案**:
1. 檢查目標 IP 和埠號
2. 確認網路連接狀態
3. 檢查防火牆設定
4. 使用 DNS 解析: `AT+QIDNSGIP="example.com"`

#### MQTT 連接問題
**症狀**: `+QMTOPEN: 0,0` 或 `+QMTCONN: 0,0` 返回錯誤
**解決方案**:
1. 檢查 MQTT 代理地址和埠號
2. 確認客戶端 ID 唯一性
3. 檢查使用者名稱和密碼
4. 確認 TLS 配置（如果使用）

### 效能優化

#### MAC 層效能優化

##### 傳輸功率優化
```at
// 根據訊號強度調整傳輸功率
AT+QPOWD=3  // 中等功率，平衡效能與功耗

// 動態功率控制
AT+QCFG="power",1  // 啟用動態功率控制
```

##### 頻道選擇優化
```at
// 選擇最佳頻段組合
AT+QCFG="band",0x80,0x800800,0x800800,0x0

// 配置載波聚合
AT+QCFG="ca",1  // 啟用載波聚合提升頻寬
```

##### MIMO 配置優化
```at
// 配置 2x2 MIMO 提升傳輸效率
AT+QMIMO=1,2

// 配置 4x4 MIMO (支援的模組)
AT+QMIMO=1,4
```

##### QoS 配置優化
```at
// 設定高優先級 QoS
AT+QCFG="qos",1,1

// 配置低延遲模式
AT+QCFG="latency",1
```

##### PDCP 層優化

###### 標頭壓縮優化
```at
// 啟用動態壓縮提升效率
AT+QPDCP=1,2,3

// 配置最佳壓縮協議
AT+QPDCP=1,2,2  // IP/UDP 壓縮

// 監控壓縮效率
AT+QPDCPEFF
```

###### 加密優化
```at
// 使用高效加密算法
AT+QENCRYPT=1,1,1  // AES + 完整性保護

// 配置序列號大小
AT+QPDCPSN=12,500  // 12位元 + 500ms 重排序
```

##### RLC 層優化

###### 視窗大小優化
```at
// 根據網路品質調整視窗大小
AT+QRLCWIN=4096,4096,1000  // 大視窗 + 長計時器

// 動態調整分段大小
AT+QRLCSEG=1500,100,1  // 動態分段
```

###### 模式選擇優化
```at
// 即時應用使用 UM 模式
AT+QRLC=2,1024,1000  // UM + 小視窗 + 短計時器

// 可靠傳輸使用 AM 模式
AT+QRLC=3,2048,2000,500  // AM + 大視窗 + 長計時器
```

#### IP 層效能優化

##### IPv4 子網路優化

###### 子網路大小優化
```at
// 根據設備數量選擇適當的子網路遮罩
// 小型網路 (≤ 254 台): /24
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.255.0"

// 中型網路 (255-1024 台): /22
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.252.0"

// 大型網路 (> 1024 台): /16
AT+CGDCONT=1,"IP","internet","192.168.1.100","255.255.0.0"
```

###### 廣播域優化
```at
// 限制廣播範圍，提升網路效能
// 分割大型廣播域
AT+QROUTE=1,"192.168.1.0","255.255.255.0","192.168.1.1"
AT+QROUTE=1,"192.168.2.0","255.255.255.0","192.168.2.1"

// 配置廣播抑制
AT+QCFG="broadcast",1,100  // 限制廣播速率
```

###### 路由優化
```at
// 配置靜態路由減少路由查詢
AT+QROUTE=1,"10.0.0.0","255.0.0.0","192.168.1.254"

// 配置預設路由
AT+QROUTE=1,"0.0.0.0","0.0.0.0","192.168.1.1"

// 檢查路由表效率
AT+QROUTE?
```

##### IPv6 效能優化

###### 前綴長度優化
```at
// 標準子網路大小 (/64) 提供最佳效能
AT+CGDCONT=1,"IPV6","internet","","","","","","2001:db8:1234::/64"

// 大型網路使用 /48 前綴
AT+CGDCONT=1,"IPV6","internet","","","","","","2001:db8:1234::/48"
```

###### 自動配置優化
```at
// 啟用 SLAAC 減少配置開銷
AT+QCFG="ipv6",1

// 配置 DHCPv6 作為備用
AT+QCFG="dhcpv6",1

// 優化路由器公告間隔
AT+QCFG="ra",1,600,1800  // 最小間隔 600s，最大間隔 1800s
```

###### IPv6 路由優化
```at
// 配置 IPv6 靜態路由
AT+QROUTE=1,"2001:db8:1234:0000::/64","2001:db8:1234::1"

// 配置 IPv6 預設路由
AT+QROUTE=1,"::/0","2001:db8:1234::1"

// 優化鄰居發現
AT+QCFG="nd",1,30,120  // 重傳間隔 30s，超時 120s
```

##### 雙棧效能優化

###### 協議優先級配置
```at
// 根據網路狀況選擇優先協議
// IPv6 優先 (現代網路)
AT+QCFG="ipv6pref",1

// IPv4 優先 (傳統網路)
AT+QCFG="ipv6pref",0

// 檢查網路支援情況
AT+QCFG="ipv6pref"?
```

###### 連接管理優化
```at
// 配置連接池大小
AT+QCFG="connpool",10  // 10 個連接

// 配置連接超時
AT+QCFG="timeout",30  // 30 秒超時

// 啟用連接重用
AT+QCFG="reuse",1
```

##### IP 層監控與調優

###### 效能監控
```at
// 監控 IP 層統計
AT+QISTATS

// 監控封包統計
AT+QPACKET?

// 監控錯誤統計
AT+QERROR?

// 監控延遲
AT+QPING="8.8.8.8"
```

#### VLAN 效能優化

##### VLAN 配置優化
```at
// 根據業務需求配置 VLAN 大小
// 小型 VLAN (≤ 100 設備): 高效能
AT+QVLAN=1,10,1,5  // VLAN 10, 標籤啟用, 優先級 5

// 中型 VLAN (100-500 設備): 平衡效能
AT+QVLAN=2,20,1,3  // VLAN 20, 標籤啟用, 優先級 3

// 大型 VLAN (> 500 設備): 需要分段
AT+QVLAN=3,30,1,1  // VLAN 30, 標籤啟用, 優先級 1
```

##### VLAN 間路由優化
```at
// 配置靜態路由減少路由查詢
AT+QROUTE=1,"192.168.10.0","255.255.255.0","192.168.1.1",10

// 配置 VLAN 預設路由
AT+QROUTE=1,"0.0.0.0","0.0.0.0","192.168.1.1",10

// 檢查 VLAN 路由效率
AT+QROUTE?
```

##### VLAN 安全優化
```at
// 配置最小權限原則的 ACL
AT+QACL=1,10,"permit","192.168.10.0","255.255.255.0","192.168.20.0","255.255.255.0"

// 配置防火牆規則
AT+QFIREWALL=1,10,"allow","tcp","80,443"

// 監控 VLAN 安全事件
AT+QVLANSTAT=10
```

##### VLAN 監控優化
```at
// 監控 VLAN 流量
AT+QVLANFLOW=10

// 監控 VLAN 錯誤
AT+QVLANERR=10

// VLAN 效能測試
AT+QPING="192.168.10.100",10
```

###### 動態調優
```at
// 根據網路品質動態調整
// 高品質網路: 大封包，低重傳
AT+QCFG="mtu",1500
AT+QCFG="retry",3

// 低品質網路: 小封包，高重傳
AT+QCFG="mtu",576
AT+QCFG="retry",5
```

#### 降低功耗
1. **PSM (Power Saving Mode)**: `AT+CPSMS=1`
2. **eDRX (Extended Discontinuous Reception)**: `AT+CEDRXS=1`
3. **適當的資料傳輸間隔**
4. **使用 UDP 而非 TCP**（適用場景）

#### 提高傳輸效率
1. **適當的封包大小**
2. **使用壓縮**: `AT+QHTTPCFG="compress",1`
3. **連接池管理**
4. **非同步處理**

### 除錯技巧

#### 啟用除錯模式
```at
// 啟用詳細錯誤訊息
AT+CMEE=2

// 啟用 AT 指令回顯
ATE1

// 查看模組狀態
AT+CPAS
```

#### 常用除錯指令
```at
// 檢查模組版本
AT+CGMR

// 檢查 IMEI
AT+CGSN=1

// 檢查 SIM 卡資訊
AT+CCID

// 檢查訊號品質
AT+CSQ

// 檢查網路註冊狀態
AT+CREG?

// 檢查 PDP 上下文狀態
AT+CGATT?
```

## 總結

本教學指南涵蓋了在 Quectel 模組上實作 TCP/IP 協議的完整知識體系，從基礎的網路架構到進階的應用層協議。透過深入理解這些協議的特性和實作方式，您將能夠：

1. **選擇合適的協議**: 根據應用需求選擇 TCP、UDP、MQTT 等
2. **優化網路效能**: 透過適當的配置和調優提升傳輸效率
3. **確保通訊安全**: 使用 TLS/HTTPS 保護資料傳輸
4. **解決常見問題**: 快速診斷和解決網路連接問題

隨著 5G 技術的發展和物聯網應用的普及，Quectel 模組將在更多場景中發揮重要作用。持續學習和實踐將幫助您掌握這些技術，並在實際專案中取得成功。

---

**參考資源**:
- [Quectel 官方文檔](https://www.quectel.com/support)
- [RFC 文檔](https://tools.ietf.org/rfc/)
- [MQTT 協議規範](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html)
- [WebSocket 協議規範](https://tools.ietf.org/html/rfc6455) 